---
date: "2018-01-01"
draft: false
lastmod: "2018-01-01"
publishdate: "2018-01-01"
tags:
- project
title: tianan非车险平台
---
## 1. 平台相关内容
非车平台项目说明：
### 1.1. 管理平台
* 用户管理
    * 用户分类
        * 管理平台用户
        * 渠道用户
        * c端用户
    * 用户角色
        * 超级管理员
        * 业务人员
        * 渠道人员
* 渠道管理
    * 渠道信息、见费/非见费、销管数据
    * 渠道产品及方案管理
    * 渠道权限管理
* 产品管理
    * 产品级别管理
    * 方案级别管理（方案同步）手动+自动
    * 非定额方案管理
* 保单管理
    * 保单查询
* 报表管理
    * 时间维度
    * 产品维度
    * 交易维度
* 监控管理
    * 交易接口监控
    * rabbitmq监控

### 1.2. 服务接口
* 接口处理流程
    * 用户身份认证
    * 用户接口权限校验
    * 用户交易类型及产品权限
    * 统一异常返回封装
* 接口清单
    * 出单
    * 退保
    * 支付
    * 电子保单下载
    * 电子发票下载
    * 保单查询

## 2. 关键技术架构
![tianan-nonecar-archtecture.png](../picture/tianan-nonecar-archtecture.png)

redis集群部署：
1. 1主2从，3哨兵实现自动切换(3台服务器)
    主从同步模式，jedis客户端使用JedisSentinelPool获取连接


rabbitmq集群部署：
1. 2个节点互备，HAProxy负载均衡
2. 通过api对集群节点及队列堆积监控

### 3. 关键技术点

订单表以每天近5-10万的数据量增长，一年的数据量将在1000万，届时单表压力将比较大，前期需要考虑进行分表。

订单号生成-分布式id方案：

使用redis自增序列获取订单号，备用数据库进行生成（订单号逢10保存一次库，避免redis节点）

分表分析：

* 订单表的数据分表维度：内部订单号

  内部订单号是唯一满足存在于整个生命周期，且查询频次高于其他的数据项

* 分表方式：从订单的时间维度进行划分

  订单号规则中包含时间戳，1个月一张数据表。

  * 插入时使用拦截器对表名进行拦截设置。

  * 查询

    * 以订单号查数据

      * 拦截设置查询的表

    * 以保单号查数据

      * 保单号唯一，从最新月份的表开始查，查到即返回

    * 以订单其他信息查订单数据（增加时间维度）

      