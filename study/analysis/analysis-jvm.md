---
date: "2018-01-01"
draft: false
lastmod: "2018-01-01"
publishdate: "2018-01-01"
tags:
- analysis
title: analysis-jvm
---


# 1. å¸¸ç”¨å‘½ä»¤åŠå‚æ•°
## 1.1. æŸ¥çœ‹å½“å‰javaå‚æ•°
> java -XshowSettings:all

## 1.2. æŸ¥çœ‹javaé…ç½®å±æ€§
java -XX:+PrintFlagsFinal -version

ç¤ºä¾‹
```
VM settings:
    Max. Heap Size (Estimated): 1.78G
    Ergonomics Machine Class: server
    Using VM: Java HotSpot(TM) 64-Bit Server VM

Property settings:
    awt.toolkit = sun.lwawt.macosx.LWCToolkit
    file.encoding = UTF-8
    file.encoding.pkg = sun.io
    file.separator = /
    ...
```

## 1.3. æ‰“å°GCç›¸å…³æ—¥å¿—
* æ‰“å°GCæ™®é€šä¿¡æ¯
    > -XX:+PrintGC

    GCç¤ºä¾‹
    ```
    [GC (Allocation Failure)  311109K->311878K(454144K), 0.1617940 secs]
    [Full GC (Ergonomics)  311878K->310823K(622592K), 0.0647834 secs]
    ```

    ç¬¬ä¸€è¡Œä¸ºæ™®é€šGCç¬¬ä¸€ä¸ªæ•°æ®[311109k]ä¸ºå›æ”¶å‰å †ç©ºé—´ä½¿ç”¨é‡ï¼Œç¬¬äºŒä¸ªæ•°æ®[311878K]ä¸ºå›æ”¶åå †å†…å­˜ä½¿ç”¨é‡ï¼Œç¬¬ä¸‰ä¸ªæ•°æ®[454144K]ä¸ºå½“å‰ç”³è¯·çš„æ€»å †ç©ºé—´å¤§å°ï¼ˆæ³¨æ„å¹¶éæœªä½¿ç”¨çš„ç©ºé—´ï¼‰ï¼Œå½“å †å†…å­˜å¤§å°æœªè¾¾åˆ°æœ€å¤§æ—¶å¯ä»¥æŒç»­ç”³è¯·ã€‚ç¬¬å››ä¸ªæ•°æ®[0.1617940 secs]ä¸ºå½“å‰GCè€—æ—¶ã€‚
    ç¬¬äºŒè¡Œä¸ºFullGC,å¹¶éæ¯æ¬¡GCéƒ½ä¼šä¼´éšFullGC


* æ‰“å°GCè¯¦ç»†ä¿¡æ¯
    > -XX:+PrintGCDetails

    ç¤ºä¾‹
    ```
    [GC (Allocation Failure) [PSYoungGen: 37134K->4752K(71680K)] 61719K->61080K(159232K), 0.0220931 secs] [Times: user=0.02 sys=0.04, real=0.02 secs] 
    [Full GC (Ergonomics) [PSYoungGen: 4752K->0K(71680K)] [ParOldGen: 56328K->60962K(133120K)] 61080K->60962K(204800K), [Metaspace: 3203K->3203K(1056768K)], 0.0123164 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
    ```
    è¯´æ˜ï¼š
**PSYoungGen** å¹´è½»ä»£ï¼ŒåŒDefNew
**ParOldGen** å¹´è€ä»£ï¼ŒåŒTenured
**Metaspace** æ°¸ä¹…ä»£ï¼ˆç±»æ–¹æ³•å­˜å‚¨åŒºï¼‰,åŒPerm

* åœ¨GCæ—¶æ‰“å°å †ä¿¡æ¯
    > -XX:+PrintHeapAtGC
    åŠ å…¥è¯¥å‚æ•°åï¼Œjvmä¼šåœ¨æ¯æ¬¡GCå‰ååˆ†åˆ«æ‰“å°å †ä¿¡æ¯
    å †ä¿¡æ¯ç¤ºä¾‹ï¼š
    ```
    PSYoungGen      total 208384K, used 4128K [0x0000000795580000, 0x00000007ab980000, 0x00000007c0000000)
    eden space 203264K, 0% used [0x0000000795580000,0x0000000795580000,0x00000007a1c00000)
    from space 5120K, 80% used [0x00000007a1c00000,0x00000007a2008040,0x00000007a2100000)
    to   space 5120K, 0% used [0x00000007ab480000,0x00000007ab480000,0x00000007ab980000)
    ParOldGen       total 652800K, used 646703K [0x0000000740000000, 0x0000000767d80000, 0x0000000795580000)
    object space 652800K, 99% used [0x0000000740000000,0x000000076778bca0,0x0000000767d80000)
    Metaspace       used 3238K, capacity 4496K, committed 4864K, reserved 1056768K
    class space    used 350K, capacity 388K, committed 512K, reserved 1048576K
    ```

    è¯´æ˜ï¼š

    **usedæ•°æ®**[0x0000000795580000,0x0000000795580000,0x00000007a1c00000)åˆ†åˆ«è¡¨ç¤ºä¸‹ç•Œã€å½“å‰ä¸Šç•Œã€ä¸Šç•Œï¼Œå¯ä»¥é€šè¿‡è¿™ä¸‰ä¸ªæ•°æ®è®¡ç®—å‡ºå½“å‰å·²ä½¿ç”¨å’Œå½“å‰å¯ä½¿ç”¨ç©ºé—´ä»¥åŠå½“å‰æ€»ç”³è¯·ç©ºé—´ã€‚

* é¢å¤–æ‰“å°GCå‘ç”Ÿçš„æ—¶é—´ï¼Œä»¥JVMå¯åŠ¨åç§»æ—¶é—´
    > -XX:+PrintGCTimeStamps

* æ‰“å°åº”ç”¨æ—¶é—´æ‰§è¡Œæ—¶é—´å’Œåœé¡¿æ—¶é—´
    > -XX:+PrintGCApplicationConcurrentTime

    > -XX:+PrintGCApplicationStoppedTime

* è·Ÿè¸ªç³»ç»Ÿå†…è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¹»å¼•ç”¨å’Œfinallizeé˜Ÿåˆ—
    > -XX:+PrintReferenceGC

* GCæ—¥å¿—è¾“å‡ºæŒ‡å®š
    > -Xloggc:path

## 1.4. ç±»åŠ è½½åŠå¸è½½è·Ÿè¸ª

* è·Ÿè¸ªåŠ è½½åŠå¸è½½
    > -verbose:class

* è·Ÿè¸ªåŠ è½½
    > -XX:+TraceClassLoading

* è·Ÿè¸ªå¸è½½
    > -XX:+TraceClassUnloading

## 1.5. æ‰“å°ç³»ç»Ÿè¿è¡Œç›¸å…³å‚æ•°
* æ‰“å°ç³»ç»Ÿè¿è¡Œçš„å‚æ•°
    > -XX:+PrintVMOptions

* æ‰“å°ä¼ é€’ç»™è™šæ‹Ÿæœºçš„æ˜¾å¼æˆ–é¥®å¼å‚æ•°
> -XX:+PrintCommandLineFlags

* æ‰“å°æ‰€æœ‰ç³»ç»Ÿå‚æ•°
    > -XX:+PrintFlagsFinal

## 1.6. å †çš„è®¾ç½®

* åˆå§‹å †ç©ºé—´
    > -Xms 

* æœ€å¤§å †ç©ºé—´
    > -Xmx

* æ–°ç”Ÿä»£ç©ºé—´
    > -Xmn

    è¯´æ˜:
    æ–°ç”Ÿä»£å¢å¤§ä¼šå‡å°è€å¹´ä»£çš„å¤§å°ï¼Œå¯¹GCå½±å“è¾ƒå¤§ï¼Œæ–°ç”Ÿä»£å¤§å°ä¸€åŠè®¾ç½®æ•´ä¸ªå †ç©ºé—´çš„1/3åˆ°1/4ã€‚

* è®¾ç½®æ–°ç”Ÿä»£edenä¸from/toåˆ°ç©ºé—´æ¯”ä¾‹
    > -XX:SurvivorRatio=

    è¯´æ˜:
    
    æ­£å¸¸è®¾ç½®2ï¼Œå³eden:from:to = 2:1:1ã€‚ç‰¹æ®Šæƒ…å†µéœ€è¦ç‰¹åˆ«è€ƒè™‘ã€‚

* è®¾ç½®æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„æ¯”ä¾‹,æ”¹æ¯”ä¾‹=è€å¹´ä»£/æ–°ç”Ÿä»£
    > -XX:NewRatio=

* **å †æº¢å‡ºå¤„ç†**

    å †æº¢å‡ºå¯¼å‡ºæ•´ä¸ªå †ä¿¡æ¯
    
    > -XX:+HeapDumpOnOutOfMemoryError

    æŒ‡å®šåˆ°å¤„è·¯å¾„
    > -XX:HeapDumpPath=

    å †æº¢å‡ºæ—¶æ‰§è¡Œä¸€ä¸ªè„šæœ¬æ–‡ä»¶
    > -XX:OnOutOfMemoryError=

## 1.7. æ–¹æ³•åŒºé…ç½®

jdk 1.6/1.7 

> -XX:PermSize
    
> -XX:MaxPermSize

jdk 1.8
> -XX:MaxMetaspaceSize=

è¯´æ˜ï¼š1.8é»˜è®¤æƒ…å†µä¸‹æ°¸ä¹…åŒºæœ€å¤§åªå—ç³»ç»Ÿå¯ç”¨å†…å­˜é™åˆ¶ã€‚

## 1.8. æ ˆé…ç½®

æ ˆç©ºé—´æ˜¯æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰ç©ºé—´ï¼Œå‚æ•°é…ç½®ï¼š
> -Xss

## 1.9. ç›´æ¥å†…å­˜é…ç½®

è¢«NIOå¹¿æ³›ä½¿ç”¨ï¼Œç›´æ¥å†…å­˜è·³è¿‡äº†javaå †ï¼Œä½¿javaç¨‹åºå¯ä»¥ç›´æ¥è®¿é—®å †ç©ºé—´ï¼Œä¸€å®šæˆç¨‹åº¦ä¸ŠåŠ å¿«äº†å†…å­˜ç©ºé—´è®¿é—®é€Ÿåº¦ã€‚
> -XX:MaxDirectMemorySize

ç›´æ¥å†…å­˜é€‚åˆç”³è¯·æ¬¡æ•°è¾ƒå°‘ï¼Œè®¿é—®è¾ƒé¢‘ç¹å †åœºåˆã€‚


# 2. åƒåœ¾å›æ”¶ç®—æ³•

## 2.1. å¼•ç”¨è®¡æ•°æ³•
* åŸç†ï¼šæ¯ä¸ªå¯¹è±¡åˆ›å»ºä¸€ä¸ªè®¡æ•°å™¨ï¼Œå½“æœ‰ä¸€ä¸ªå¯¹è±¡å¼•ç”¨å®ƒæ—¶è®¡æ•°åŠ 1ï¼Œå½“å¼•ç”¨å¤±æ•ˆæ—¶è®¡æ•°å‡1ï¼Œå½“è®¡æ•°ä¸º0æ—¶ä¸å¯å†å¼•ç”¨ã€‚
* å­˜åœ¨å¦‚ä¸‹é—®é¢˜ï¼Œjvmåƒåœ¾å›æ”¶æœªä½¿ç”¨è¯¥ç®—æ³•
    * å¾ªç¯å¼•ç”¨å¯¼è‡´å†…å­˜æ³„æ¼ï¼ˆå¦‚Aã€Bäº’ç›¸å¼•ç”¨ï¼Œæ— ç¬¬ä¸‰ä¸ªå¯¹è±¡å¯¹Aæˆ–Bå¼•ç”¨ï¼Œä½†æ˜¯Aã€Bçš„è®¡æ•°éƒ½ä¸ä¸º0æ— æ³•å›æ”¶ï¼‰
    * å¼•ç”¨è®¡ç®—å™¨åœ¨å¼•ç”¨å’Œå¤±æ•ˆæ—¶éœ€è¦å¯¹è®¡æ•°å™¨è¿›è¡Œæ“ä½œï¼Œå¯¹ç³»ç»Ÿæ€§èƒ½æœ‰å½±å“ã€‚

## 2.2. æ ‡è®°æ¸…é™¤æ³•
* åŸç†ï¼šä»æ ¹ç»“ç‚¹å¼€å§‹éå†å¯è¾¾å¯¹è±¡å¹¶æ ‡è®°ï¼Œæ¸…ç†é˜¶æ®µå¯¹æœªæ ‡è®°çš„å¯¹è±¡è¿›è¡Œæ¸…ç†
* ç¼ºç‚¹ï¼šå›æ”¶çš„ç©ºé—´ä¸è¿ç»­ï¼Œåœ¨å¯¹è±¡çš„å †ç©ºé—´åˆ†é…è¿‡ç¨‹ä¸­ï¼Œå·¥ä½œæ•ˆç‡ä½ä¸‹ã€‚

## 2.3. å¤åˆ¶ç®—æ³•
* åŸç†ï¼šå°†åŸæœ‰ç©ºé—´åˆ†æˆä¸¤å—ï¼Œæ¯æ¬¡ä½¿ç”¨ä¸€å—ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶æŠŠæ­£åœ¨ä½¿ç”¨ä¸­çš„å†…å­˜ä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°æœªä½¿ç”¨çš„å†…å­˜ä¸­ï¼Œä¹‹åæ¸…ç†æ­£åœ¨ä½¿ç”¨çš„å†…å­˜ä¸­çš„æ‰€æœ‰å¯¹è±¡ï¼Œäº¤æ¢ä¸¤ä¸ªå†…å­˜è§’è‰²ã€‚
* ä¼˜ç‚¹ï¼šæ— å†…å­˜ç¢ç‰‡ï¼Œ
* ç¼ºç‚¹ï¼šç©ºé—´ä½¿ç”¨ç‡æŠ˜åŠï¼Œå½“å­˜æ´»å¯¹è±¡è¾ƒå¤šæ—¶ï¼Œéœ€è¦å¤åˆ¶çš„å¯¹è±¡ä¹Ÿå¤šã€‚
* å¤åˆ¶ç®—æ³•æ¯”è¾ƒé€‚åˆæ–°ç”Ÿä»£ï¼Œæ–°ç”Ÿä»£åƒåœ¾å¯¹è±¡é€šå¸¸å¤šä½™å­˜æ´»å¯¹è±¡ã€‚

## 2.4. æ ‡è®°å‹ç¼©æ³•ï¼ˆæ ‡è®°æ¸…é™¤å‹ç¼©ç®—æ³•ï¼‰
* åŸç†ï¼šä¼˜åŒ–æ ‡è®°æ¸…é™¤ï¼Œæ¸…é™¤é˜¶æ®µå°†æ‰€æœ‰å­˜æ´»å¯¹è±¡å‹ç¼©åˆ°å†…å­˜å¦ä¸€ç«¯ï¼Œä¹‹åæ¸…ç†è¾¹ç•Œå¤–çš„æ‰€æœ‰ç©ºé—´ã€‚ç›¸å½“äºåœ¨æ ‡è®°æ¸…é™¤çš„åŸºç¡€ä¸ŠåŠ äº†å†…å­˜æ•´ç†ã€‚

## 2.5. åˆ†ä»£ç®—æ³•
* æ–°ç”Ÿä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£ä½¿ç”¨æ ‡è®°å‹ç¼©æˆ–è€…æ ‡è®°æ¸…é™¤ç®—æ³•
* å¡è¡¨æ•°æ®ç»“æ„ä¼˜åŒ–é«˜é¢‘ç‡çš„æ–°ç”Ÿä»£å›æ”¶ï¼ˆå¡è¡¨ä¸ºä¸€ä¸ªæ¯”ç‰¹ä½é›†åˆï¼Œæ¯1ä½è¡¨ç¤ºè€å¹´ä»£ä¸€ä¸ª4kç©ºé—´å¤šè€å¹´ä»£ä¸­å¤šå¯¹è±¡æ˜¯å¦æŒæœ‰æ–°ç”Ÿä»£å¯¹è±¡ï¼Œå¦‚æœè¯¥ä½ä¸º1è¡¨ç¤ºæœ‰ï¼ŒGCæ—¶éœ€è¦æ‰«æè¯¥ä½è¡¨ç¤ºçš„ç©ºé—´å¼•ç”¨å…³ç³»ï¼Œä¸º0è·³è¿‡ï¼‰

## 2.6. åˆ†åŒºç®—æ³•
* åŸç†ï¼šå°†å¤§çš„å †å†…å­˜ç©ºé—´åˆ†æˆè‹¥å¹²å°å—ï¼Œæ¯æ¬¡å›æ”¶è‹¥å¹²å—ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å›æ”¶ï¼Œæ ¹æ®ç›®æ ‡åœé¡¿æ—¶é—´æ¥åˆç†çš„å›æ”¶ã€‚è¿™ç§æ–¹æ³•å®¹æ˜“æ§åˆ¶åœ¨GCæ—¶çš„å¡é¡¿æ—¶é—´ã€‚


# 3. javaå¼•ç”¨åŠåƒåœ¾å›æ”¶
* å¼ºå¼•ç”¨
* è½¯å¼•ç”¨-å†…å­˜ç´§å¼ æ—¶å›æ”¶
* å¼±å¼•ç”¨-å‘ç°å³å›æ”¶
* è™šå¼•ç”¨-æœ€å¼±ï¼Œå‘ç°å³å›æ”¶ï¼Œå¿…é¡»å’Œå¼•ç”¨é˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨ï¼Œç”¨äºå¯¹è±¡å›æ”¶è·Ÿè¸ª

**è¯´æ˜ï¼š**
è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨é€‚ç”¨äºç¼“å­˜å¤„ç†ã€‚


# 4. åƒåœ¾å›æ”¶å™¨

## 4.1. ä¸²è¡Œå›æ”¶å™¨

* javaæœ€å¤è€çš„åƒåœ¾å›æ”¶å™¨ä¹‹ä¸€ï¼Œä»…ä»…ä½¿ç”¨å•çº¿ç¨‹è¿›è¡Œç‹¬å å¼çš„åƒåœ¾å›æ”¶ï¼Œé€ æˆå…¶ä»–çº¿ç¨‹è¿›å…¥ç­‰å¾…ï¼Œäº§ç”Ÿç³Ÿç³•çš„ç”¨æˆ·ä½“éªŒã€‚å½“åƒåœ¾å›æ”¶æ—¶é—´å ç”¨å¢å¤§æ—¶ï¼Œå¯¹ååé‡çš„å½±å“ç‰¹åˆ«å¤§ã€‚ä¸¤ä¸ªç‰¹ç‚¹ï¼š
    1. ä»…ä»…ä½¿ç”¨å•ä¸ªçº¿ç¨‹è¿›è¡Œåƒåœ¾å›æ”¶
    2. ç‹¬å å¼çš„åƒåœ¾å›æ”¶
* ä¸²è¡Œæ”¶é›†å™¨é€‚ç”¨äºä¸€äº›å°åº”ç”¨ï¼ˆæœ€å¤§100Mçš„å †ç©ºé—´ï¼‰ï¼Œå•cpuå¤„ç†å™¨ä¸‹è¿è¡Œé«˜æ•ˆï¼Œè¶…è¿‡å¹¶è¡Œå›æ”¶å™¨å’Œå¹¶å‘å›æ”¶å™¨ã€‚
    
### 4.1.1. æ–°ç”Ÿä»£ä¸²è¡Œå›æ”¶å™¨

* å¯ç”¨æ–°ç”Ÿä»£ä¸²è¡Œæ”¶é›†å™¨å’Œè€å¹´ä»£ä¸²è¡Œæ”¶é›†å™¨ï¼ŒæŒ‡å®šå‚æ•° **-XX:+UseSerialGC**ï¼Œjvm clientè¿è¡Œæ¨¡å¼ä¸‹çš„é»˜è®¤åƒåœ¾å›æ”¶å™¨ã€‚
* æ–°ç”Ÿä»£ä¸²è¡Œå›æ”¶å™¨ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œç®€å•é«˜æ•ˆã€‚

### 4.1.2. è€å¹´ä»£ä¸²è¡Œå›æ”¶å™¨

* è€å¹´ä»£ä¸²è¡Œæ”¶é›†å™¨ä½¿ç”¨æ ‡è®°å‹ç¼©ç®—æ³•ã€‚
* åœ¨å †ç©ºé—´è¾ƒå¤§çš„åº”ç”¨ç¨‹åºï¼Œä¸€æ—¦è€å¹´ä»£ä¸²è¡Œæ”¶é›†å™¨å¯åŠ¨ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½ä¼šå› æ­¤åœé¡¿è¾ƒé•¿çš„æ—¶é—´ã€‚
* è€å¹´ä»£ä¸²è¡Œå›æ”¶å™¨å¯ä»¥å’Œå¤šç§æ–°ç”Ÿä»£åƒåœ¾å›æ”¶å™¨é…åˆä½¿ç”¨ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä½œä¸ºCMSå›æ”¶å™¨çš„å¤‡ç”¨å›æ”¶å™¨ã€‚
* å¯ç”¨è€å¹´ä»£ä¸²è¡Œå›æ”¶å™¨
    * **-XX:+UseSerialGC** æ–°ç”Ÿä»£ã€è€å¹´ä»£éƒ½ä½¿ç”¨ä¸²è¡Œå›æ”¶å™¨
    * **-XX:+UseParNewGC** æ–°ç”Ÿä»£ä½¿ç”¨ParNewGCå›æ”¶å™¨ï¼Œè€å¹´ä»£ä½¿ç”¨ä¸²è¡Œå›æ”¶å™¨
    * **-XX:+UseParallelGC** æ–°ç”Ÿä»£ä½¿ç”¨ParallelGCå›æ”¶å™¨ï¼Œè€å¹´ä»£ä½¿ç”¨ä¸²è¡Œå›æ”¶å™¨




## 4.2. å¹¶è¡Œå›æ”¶å™¨ï¼ˆParNewï¼‰

### 4.2.1. æ–°ç”Ÿä»£ParNewå›æ”¶å™¨
* ParNewå›æ”¶å™¨æ˜¯å·¥ä½œåœ¨æ–°ç”Ÿä»£çš„å¹¶è¡Œå›æ”¶å™¨ï¼Œåªæ˜¯ç®€å•çš„å°†ç©¿è¡Œå›æ”¶å™¨å¤šçº¿ç¨‹åŒ–ï¼Œå…¶å›æ”¶ç­–ç•¥ã€ç®—æ³•ä»¥åŠå‚æ•°å’Œæ–°ç”Ÿä»£ä¸²è¡Œå›æ”¶å™¨ä¸€æ ·ã€‚
* åœ¨å•CPUæˆ–è€…å¹¶å‘èƒ½åŠ›è¾ƒå¼±çš„ç³»ç»Ÿä¸­ï¼Œå¹¶è¡Œå›æ”¶å™¨çš„æ•ˆæœä¸ä¼šæ¯”ä¸²è¡Œå›æ”¶å™¨å¥½ã€‚
* å¼€å¯ParNewå›æ”¶å™¨
    * **-XX:+UseParNewGC** æ–°ç”Ÿä»£ä½¿ç”¨ParNewå›æ”¶å™¨ï¼Œè€å¹´ä»£ä½¿ç”¨ä¸²è¡Œå›æ”¶å™¨ã€‚
    * **-XX:+UseConcMarkSweepGC** æ–°ç”Ÿä»£ä½¿ç”¨ParNewå›æ”¶å™¨ï¼Œè€å¹´ä»£ä½¿ç”¨CMSã€‚
* ParNewå›æ”¶å™¨å·¥ä½œæ—¶çš„çº¿ç¨‹æ•°é‡æŒ‡å®šã€‚
    * **-XX:ParalleGCThreads**

    çº¿ç¨‹æ•°ä¸€èˆ¬ä¸CPUæ•°é‡ç›¸å½“ï¼Œé¿å…è¿‡å¤šçš„çº¿ç¨‹æ•°ï¼Œå½±å“åƒåœ¾æ”¶é›†æ€§èƒ½ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“CPUæ•°é‡å°äº8æ—¶ï¼ŒParallelGCThreadsçš„å€¼ç­‰äºCPUæ•°é‡ï¼Œå½“CPUæ•°é‡å¤§äº8ä¸ªæ—¶ï¼ŒParallelGCThreadsçš„å€¼ç­‰äº3+((5*CPU_COUNT)/8)

### 4.2.2. æ–°ç”Ÿä»£ParallelGCå›æ”¶å™¨
* ä¸ParNewç›¸åŒç‚¹ï¼šå¤šçº¿ç¨‹ï¼Œç‹¬å å¼ã€‚
* é‡è¦ç‰¹æ€§ï¼šéå¸¸å…³æ³¨ç³»ç»Ÿååé‡ã€‚
* å¯ç”¨å‚æ•°ï¼š
    * **-XX:+UseParalleGC** æ–°ç”Ÿä»£ä½¿ç”¨ParallelGCå›æ”¶å™¨ï¼Œè€å¹´ä»£ä½¿ç”¨ä¸²è¡Œå›æ”¶å™¨
    * **-XX:+UseParallelOldGC** æ–°ç”Ÿä»£ä½¿ç”¨ParallelGCå›æ”¶å™¨ï¼Œè€å¹´ä»£ä½¿ç”¨ParallelOldGCå›æ”¶å™¨
* ååæ§åˆ¶å‚æ•°
    * **-XX:MaxGCPauseMillis** æœ€å¤§åƒåœ¾æ”¶é›†åœé¡¿æ—¶é—´ã€‚è¯¥å€¼å½“è®¾å®šå¹¶éè¶Šå°è¶Šå¥½ï¼Œå› ä¸ºè¶Šå°å¯èƒ½ä¼šå¢åŠ gcçš„é¢‘ç‡ï¼Œåè€Œå¯èƒ½é™ä½åå
    * **-XX:GCTimeRatio** è®¾ç½®ååé‡å¤§å°ï¼Œ0-100ä¹‹é—´ã€‚è¯¥æ¯”ç‡ä¸ºåƒåœ¾å›æ”¶æ—¶é—´/æ€»æ—¶é—´ã€‚
* è‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥æ”¯æŒ
    * **-XX:UseAdaptiveSizePolicy** å¯ä»¥æ‰“å¼€è‡ªé€‚åº”GCç­–ç•¥

    åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ–°ç”Ÿä»£çš„å¤§å°ã€edenå’Œsurviviorçš„æ¯”ä¾‹ã€æ™‹å‡è€å¹´ä»£çš„å¯¹è±¡å¹´é¾„ç­‰å‚æ•°ä¼šè¢«è‡ªåŠ¨è°ƒæ•´ä¸€é“é“åœ¨å †å¤§å°ã€ååé‡å’Œåœé¡¿æ—¶é—´ä¹‹é—´çš„å¹³è¡¡ç‚¹ã€‚åœ¨æ‰‹å·¥è°ƒä¼˜æ¯”è¾ƒå›°éš¾çš„åœºåˆï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ç§è‡ªé€‚åº”çš„æ–¹å¼ã€‚ä»…æŒ‡å®šè™šæ‹Ÿæœºçš„æœ€å¤§å †ã€ç›®æ ‡ååé‡å’Œåœé¡¿æ—¶é—´ï¼Œè®©è™šæ‹Ÿæœºè‡ªå·±å®Œæˆè°ƒä¼˜å·¥ä½œã€‚


### 4.2.3. è€å¹´ä»£ParallelOldGCå›æ”¶å™¨
* å’ŒParallelGCæ–°ç”Ÿä»£å›æ”¶å™¨æ­é…ä½¿ç”¨
* ä½¿ç”¨æ ‡è®°å‹ç¼©ç®—æ³•
* å¯ç”¨å‚æ•°
    * **-XX:+UseParallelOldGC** æ–°ç”Ÿä»£ä½¿ç”¨ParallelGCå›æ”¶å™¨ï¼Œè€å¹´ä»£ä½¿ç”¨ParallelOldGCå›æ”¶å™¨ã€‚
* å›æ”¶çº¿ç¨‹æ•°è®¾ç½®
    * **-XX:ParalleGCThreads**

## 4.3. CMSå›æ”¶å™¨ï¼ˆConcurrent Mark Sweepï¼‰

* è¯¥å›æ”¶å™¨å…³æ³¨ç³»ç»Ÿåœé¡¿æ—¶é—´
* ä½¿ç”¨æ ‡è®°æ¸…é™¤ç®—æ³•ã€‚
* éç‹¬å å¼ï¼Œä»…åˆå§‹æ ‡è®°å’Œé‡æ–°æ ‡è®°æ—¶ç‹¬å ã€‚
* å·¥ä½œæµç¨‹
![å·¥ä½œæµç¨‹](../../picture/CMSå›æ”¶å™¨å·¥ä½œæµç¨‹.png)
åœ¨å¹¶å‘æ ‡è®°ä¹‹åä¼šæœ‰ä¸€ä¸ªé¢„æ¸…ç†æ“ä½œï¼Œè¯¥æ“ä½œæ˜¯å¹¶å‘çš„ï¼Œå‡ºäº†ä¸ºæ­£å¼æ¸…ç†åšå‡†å¤‡å’Œæ£€æŸ¥æ„å¤–ï¼Œé¢„æ¸…ç†è¿˜ä¼šå°è¯•æ§åˆ¶ä¸€æ¬¡åœé¡¿æ—¶é—´ã€‚è¿™ä¸ªè¿‡ç¨‹å¯ä»¥é€šè¿‡å‚æ•° **-XX:-CMSPrecleaningEnabled** å…³é—­
* å¯ç”¨å‚æ•°
    * **-XX:+UseConcMarkSweepGC**
* å…¶ä»–å‚æ•°
    * **-XX:ConGCThreads**æˆ–è€… **-XX:ParallelCMSThreads** å¹¶å‘çº¿ç¨‹æ•°è®¾ç½®ã€‚é»˜è®¤å¯åŠ¨çš„å¹¶å‘çº¿ç¨‹æ•°ä¸ºï¼ˆParallelGCThreads+3ï¼‰/4ï¼ŒParallelGCThreadsè¡¨ç¤ºGCå¹¶è¡Œï¼ˆéå¹¶å‘ï¼‰æ—¶ä½¿ç”¨çš„çº¿ç¨‹æ•°ã€‚
    * **-XX:CMSInitiatingOccupancyFraction** æŒ‡å®šè€å¹´ä»£æ‰§è¡ŒCMSå›æ”¶è§¦å‘å€¼ï¼Œè¯¥å€¼ä¸ºè€å¹´ä»£ç©ºé—´ä½¿ç”¨ç‡ã€‚å¦‚æœå†…å­˜å¢é•¿ç¼“æ…¢å¯ä»¥è®¾ç½®ç¨å¤§ç‚¹ï¼Œå‡å°‘cmså›æ”¶çš„æ¬¡æ•°ï¼Œå¯ä»¥æ˜æ˜¾æ”¹å–„åº”ç”¨ç¨‹åºæ€§èƒ½ï¼Œåä¹‹åˆ™åº”è¯¥é™ä½è¿™ä¸ªé˜€å€¼ï¼Œé¿å…é¢‘ç¹å‡ºå‘è€å¹´ä»£ä¸²è¡Œæ”¶é›†å™¨ã€‚
    * **-XX:+UseCMSCompactAtFullCollection** è®¾ç½®CMSåœ¨åƒåœ¾æ”¶é›†å®Œæˆåè¿›è¡Œä¸€æ¬¡å†…å­˜ç¢ç‰‡æ•´ç†ï¼ˆç”±äºCMSç®—æ³•ä¸ºæ ‡è®°æ¸…é™¤ï¼Œä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œå¯¼è‡´è™½ç„¶æœ‰å†…å­˜ç©ºé—´ï¼Œä½†å¯èƒ½ç¢°åˆ°å¤§å†…å­˜ç©ºé—´åˆ†é…æ—¶å‡ºç°æ— æ³•åˆ†é…ï¼Œç„¶åå†æ¬¡å‡ºå‘åƒåœ¾å›æ”¶ï¼‰
    * **-XX:CMSFullGCsBeforeCompaction** è®¾å®šè¿›è¡Œå¤šå¥½æ¬¡CMSå›æ”¶åè¿›è¡Œä¸€æ¬¡å†…å­˜å‹ç¼©ã€‚
    * **-XX:+CMSClassUnloadingEnabled** ä½¿ç”¨CMSå›æ”¶permåŒºã€‚æŒ‡å®šè¯¥å‚æ•°åå¦‚æœæ¡ä»¶å…è®¸é‚£ä¹ˆç³»ç»Ÿä¼šä½¿ç”¨CMSçš„æœºåˆ¶å›æ”¶PermåŒºClassæ•°æ®

## 4.4. G1ï¼ˆGarbage First Garbage Collectorï¼‰å›æ”¶å™¨ï¼ˆè‡ª1.7ï¼‰

* ä½œä¸ºCMSå›æ”¶å™¨çš„æ›¿ä»£è€…
* ä½¿ç”¨äº†å…¨æ–°çš„åˆ†åŒºç®—æ³•ï¼š
    * å¹¶è¡Œæ€§ã€‚å¤šä¸ªGCçº¿ç¨‹åŒæ—¶å·¥ä½œï¼Œæœ‰æ•ˆåˆ©ç”¨å¤šæ ¸è®¡ç®—èƒ½åŠ›
    * å¹¶å‘è¡Œã€‚æ‹¥æœ‰ä¸åº”ç”¨ç¨‹åºäº¤æ›¿æ‰§è¡Œçš„èƒ½åŠ›
    * åˆ†ä»£GCã€‚åŒæ—¶å…¼é¡¾å¹´è½»ä»£å’Œè€å¹´ä»£åƒåœ¾å›æ”¶ã€‚
    * ç©ºé—´æ•´ç†ã€‚æ¯æ¬¡å›æ”¶éƒ½ä¼šæœ‰æ•ˆçš„å¤åˆ¶å¯¹è±¡ï¼Œå‡å°‘ç©ºé—´ç¢ç‰‡ã€‚
    * å¯é¢„è§æ€§ã€‚G1å¯ä»¥åªé€‰å–éƒ¨åˆ†åŒºåŸŸè¿›è¡Œå†…å­˜å›æ”¶ï¼Œç¼©å°äº†å›æ”¶çš„èŒƒå›´ï¼Œå› æ­¤å¯¹äºå…¨å±€åœé¡¿èƒ½å¾—åˆ°è¾ƒå¥½çš„æ§åˆ¶ã€‚
* æ”¶é›†è¿‡ç¨‹
    * æ–°ç”Ÿä»£GC
    * å¹¶å‘æ ‡è®°å‘¨æœŸã€‚å¹¶å‘é˜¶æ®µä¸CMSç±»ä¼¼ï¼Œéƒ½ä¸ºäº†é™ä½ä¸€æ¬¡åœé¡¿æ—¶é—´å°†å¯ä»¥å’Œåº”ç”¨ç¨‹åºå¹¶å‘çš„éƒ¨åˆ†å•ç‹¬æå–å‡ºæ¥æ‰§è¡Œã€‚
        * åˆå§‹æ ‡è®°
        * æ ¹åŒºåŸŸæ‰«æ
        * å¹¶å‘æ ‡è®°
        * é‡æ–°æ ‡è®°
        * ç‹¬å æ¸…ç†
        * å¹¶å‘æ¸…ç†é˜¶æ®µ
    * æ··åˆå›æ”¶ã€‚è¿™ä¸ªé˜¶æ®µæ—¢ä¼šæ‰§è¡Œæ­£å¸¸çš„å¹´è½»ä»£GCï¼Œåˆä¼šé€‰å–ä¸€äº›è¢«æ ‡è®°çš„è€å¹´ä»£åŒºåŸŸè¿›è¡Œå›æ”¶ï¼Œå®ƒåŒæ—¶å¤„ç†äº†æ–°ç”Ÿä»£å’Œè€å¹´ä»£ã€‚
    * å¦‚æœéœ€è¦è¿›è¡ŒFullGCã€‚
* å¯ç”¨å‚æ•°
    * **-XX:+UseG1GC** æ‰“å¼€G1æ”¶é›†å™¨å¼€å…³
* å…¶ä»–å‚æ•°
    * **-XX:MaxGCPauseMills**æŒ‡å®šç›®æ ‡æœ€å¤§åƒåœ¾å›æ”¶æ—¶é—´ã€‚å¦‚æœä»»ä½•ä¸€æ¬¡åœé¡¿è¶…è¿‡è¿™ä¸ªè®¾ç½®å€¼æ—¶ï¼ŒG1å°±ä¼šå°è¯•è°ƒæ•´æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„æ¯”ä¾‹ã€è°ƒæ•´å †å¤§å°ã€è°ƒæ•´æ™‹å‡å¹´é¾„ç­‰æ‰‹æ®µè¯•å›¾è¾¾åˆ°é¢„è®¾ç›®æ ‡
    * **-XX:ParallelGCThreads** å¹¶è¡Œå›æ”¶æ—¶gcçš„å·¥ä½œçº¿ç¨‹æ•°é‡ã€‚
    * **-XX:InitiatingHeapOccupancyPercent** æŒ‡å®šå½“æ•´ä¸ªå †ä½¿ç”¨ç‡è¾¾åˆ°å¤šå°‘æ—¶è§¦å‘å¹¶å‘æ ‡è®°å‘¨æœŸçš„æ‰§è¡Œï¼Œé»˜è®¤45ã€‚ä¸€æ—¦è¯¥å€¼è®¾å®šï¼Œé‚£ä¹ˆG1ä¸ä¼šè¯•å›¾æ”¹å˜è¿™ä¸ªå€¼æ¥æ»¡è¶³æœ€å¤§åœé¡¿æ—¶é—´çš„ç›®æ ‡ã€‚è°¨æ…è®¾ç½®ï¼Œè¿‡å¤§ä¼šå¼•èµ·fullGCçš„å¯èƒ½è¡Œï¼Œè¿‡å°ä¼šä½¿å¾—å¹¶å‘å‘¨æœŸé¢‘ç¹ï¼Œå¤§é‡GCçº¿ç¨‹æŠ¢å cpuï¼Œå¯¼è‡´åº”ç”¨ç¨‹åºçº¿ç¨‹ä¸‹é™ã€‚

## 4.5. é»˜è®¤åƒåœ¾å›æ”¶å™¨

* jdk9 é»˜è®¤åƒåœ¾å›æ”¶å™¨ä¸ºG1
* jdk7å’Œjdk8
    * æ‹¥æœ‰è‡³å°‘ä¸¤ä¸ªå¤„ç†å™¨å’Œè‡³å°‘2Gå†…å­˜å¹¶åœ¨æœåŠ¡æ¨¡å¼ä¸‹è¿è¡Œçš„é»˜è®¤GCä¸ºparallel collector
    * clientæ¨¡å¼ï¼ˆå•å¤„ç†å™¨æˆ–32ä½æ“ä½œç³»ç»Ÿï¼‰ä½¿ç”¨serseial collectorã€‚

# 5. åƒåœ¾å›æ”¶è¿‡ç¨‹åŠè°ƒä¼˜

## 5.1. åƒåœ¾å›æ”¶è¿‡ç¨‹
å½“ä»£ä¸»æµè™šæ‹Ÿæœºï¼ˆHotspot VMï¼‰çš„åƒåœ¾å›æ”¶éƒ½é‡‡ç”¨â€œåˆ†ä»£å›æ”¶â€çš„ç®—æ³•ã€‚â€œåˆ†ä»£å›æ”¶â€æ˜¯åŸºäºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼šå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä¸åŒï¼Œæ‰€ä»¥é’ˆå¯¹ä¸åŒç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡å¯ä»¥é‡‡å–ä¸åŒçš„å›æ”¶æ–¹å¼ï¼Œä»¥ä¾¿æé«˜å›æ”¶æ•ˆç‡ã€‚

Hotspot VMå°†å†…å­˜åˆ’åˆ†ä¸ºä¸åŒçš„ç‰©ç†åŒºï¼Œå°±æ˜¯â€œåˆ†ä»£â€æ€æƒ³çš„ä½“ç°ã€‚å¦‚å›¾æ‰€ç¤ºï¼ŒJVMå†…å­˜ä¸»è¦ç”±æ–°ç”Ÿä»£ã€è€å¹´ä»£ã€æ°¸ä¹…ä»£æ„æˆã€‚
![å†…å­˜ç»“æ„](../../picture/å†…å­˜ç»“æ„.png)

â‘  æ–°ç”Ÿä»£ï¼ˆYoung Generationï¼‰ï¼šå¤§å¤šæ•°å¯¹è±¡åœ¨æ–°ç”Ÿä»£ä¸­è¢«åˆ›å»ºï¼Œå…¶ä¸­å¾ˆå¤šå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå¾ˆçŸ­ã€‚æ¯æ¬¡æ–°ç”Ÿä»£çš„åƒåœ¾å›æ”¶ï¼ˆåˆç§°Minor GCï¼‰ååªæœ‰å°‘é‡å¯¹è±¡å­˜æ´»ï¼Œæ‰€ä»¥é€‰ç”¨å¤åˆ¶ç®—æ³•ï¼Œåªéœ€è¦å°‘é‡çš„å¤åˆ¶æˆæœ¬å°±å¯ä»¥å®Œæˆå›æ”¶ã€‚

æ–°ç”Ÿä»£å†…åˆåˆ†ä¸‰ä¸ªåŒºï¼šä¸€ä¸ªEdenåŒºï¼Œä¸¤ä¸ªSurvivoråŒºï¼ˆä¸€èˆ¬è€Œè¨€ï¼‰ï¼Œå¤§éƒ¨åˆ†å¯¹è±¡åœ¨EdenåŒºä¸­ç”Ÿæˆã€‚å½“EdenåŒºæ»¡æ—¶ï¼Œè¿˜å­˜æ´»çš„å¯¹è±¡å°†è¢«å¤åˆ¶åˆ°ä¸¤ä¸ªSurvivoråŒºï¼ˆä¸­çš„ä¸€ä¸ªï¼‰ã€‚å½“è¿™ä¸ªSurvivoråŒºæ»¡æ—¶ï¼Œæ­¤åŒºçš„å­˜æ´»ä¸”ä¸æ»¡è¶³â€œæ™‹å‡â€æ¡ä»¶çš„å¯¹è±¡å°†è¢«å¤åˆ¶åˆ°å¦å¤–ä¸€ä¸ªSurvivoråŒºã€‚å¯¹è±¡æ¯ç»å†ä¸€æ¬¡ **Minor GC**ï¼Œå¹´é¾„åŠ 1ï¼Œè¾¾åˆ°â€œæ™‹å‡å¹´é¾„é˜ˆå€¼â€åï¼Œè¢«æ”¾åˆ°è€å¹´ä»£ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿç§°ä¸ºâ€œæ™‹å‡â€ã€‚ï¼ˆâ€œæ™‹å‡å¹´é¾„é˜ˆå€¼â€çš„å¤§å°ç›´æ¥å½±å“ç€å¯¹è±¡åœ¨æ–°ç”Ÿä»£ä¸­çš„åœç•™æ—¶é—´ï¼Œåœ¨Serialå’ŒParNew GCä¸¤ç§å›æ”¶å™¨ä¸­ï¼Œâ€œæ™‹å‡å¹´é¾„é˜ˆå€¼â€é€šè¿‡å‚æ•° **MaxTenuringThreshold** è®¾å®šï¼Œé»˜è®¤å€¼ä¸º15ã€‚**TargetSurvivorRatio**,å¯¹è±¡æ™‹å‡çš„å¦å¤–ä¸€ä¸ªé‡è¦å‚æ•°ï¼Œç”¨äºè®¾ç½®survivoråŒºçš„ä½¿ç”¨ç‡ï¼Œé»˜è®¤ä¸º50ï¼Œå¦‚æœsurvivoråŒºåœ¨gcåè¶…è¿‡50%çš„ä½¿ç”¨ç‡ï¼Œé‚£ä¹ˆå°±å¾ˆæœ‰å¯èƒ½ä½¿ç”¨è¾ƒå°çš„ageä½œä¸ºæ™‹å‡å¹´é¾„è€ŒéMaxTenuringThresholdæŒ‡å®šçš„å€¼ã€‚å¦å¤–è¿˜éœ€å…³æ³¨ï¼Œå¤§å¯¹è±¡ï¼ˆedenåŒºæˆ–è€…survivoråŒºéƒ½æ— æ³•å®¹çº³ï¼‰å¯èƒ½ç›´æ¥è¢«æ”¾å…¥è€å¹´ä»£ã€‚ï¼‰

â‘¡ è€å¹´ä»£ï¼ˆOld Generationï¼‰ï¼šåœ¨æ–°ç”Ÿä»£ä¸­ç»å†äº†Næ¬¡åƒåœ¾å›æ”¶åä»ç„¶å­˜æ´»çš„å¯¹è±¡ï¼Œå°±ä¼šè¢«æ”¾åˆ°å¹´è€ä»£ï¼Œè¯¥åŒºåŸŸä¸­å¯¹è±¡å­˜æ´»ç‡é«˜ã€‚è€å¹´ä»£çš„åƒåœ¾å›æ”¶ï¼ˆåˆç§° **Major GC**ï¼‰é€šå¸¸ä½¿ç”¨â€œæ ‡è®°-æ¸…ç†â€æˆ–â€œæ ‡è®°-æ•´ç†â€ç®—æ³•ã€‚æ•´å †åŒ…æ‹¬æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„åƒåœ¾å›æ”¶ç§°ä¸º **Full GC**ï¼ˆHotSpot VMé‡Œï¼Œé™¤äº†CMSä¹‹å¤–ï¼Œå…¶å®ƒèƒ½æ”¶é›†è€å¹´ä»£çš„GCéƒ½ä¼šåŒæ—¶æ”¶é›†æ•´ä¸ªGCå †ï¼ŒåŒ…æ‹¬æ–°ç”Ÿä»£ï¼‰ã€‚

â‘¢ æ°¸ä¹…ä»£ï¼ˆPerm Generationï¼‰ï¼šä¸»è¦å­˜æ”¾å…ƒæ•°æ®ï¼Œä¾‹å¦‚Classã€Methodçš„å…ƒä¿¡æ¯ï¼Œä¸åƒåœ¾å›æ”¶è¦å›æ”¶çš„Javaå¯¹è±¡å…³ç³»ä¸å¤§ã€‚ç›¸å¯¹äºæ–°ç”Ÿä»£å’Œå¹´è€ä»£æ¥è¯´ï¼Œè¯¥åŒºåŸŸçš„åˆ’åˆ†å¯¹åƒåœ¾å›æ”¶å½±å“æ¯”è¾ƒå°ã€‚


## 5.2. è°ƒä¼˜
### 5.2.1. ç¡®å®šè°ƒä¼˜ç›®æ ‡
ååé‡å’Œæœ€ä½å»¶è¿Ÿæ˜¯ä¸¤ä¸ªè°ƒä¼˜æ–¹å‘ï¼Œä¸èƒ½äºŒè€…å…¼é¡¾ï¼Œæœ€ä½å»¶è¿Ÿæ„å‘³ç€åœé¡¿æ—¶é—´å¯¹æ—¶é—´é™åˆ¶ï¼Œåœé¡¿æ—¶é—´è¶Šä½æ„å‘³ç€ååé™ä½æˆ–è€…æ›´å¤šçš„å†…å­˜è¦æ±‚ã€‚è°ƒä¼˜ç›®æ ‡ä¼˜å…ˆçº§é¡ºåºåº”è¯¥æŒ‰ç…§å¦‚ä¸‹é¡ºåºä¾æ¬¡æ¥æ»¡è¶³ï¼š
1. æœ€å¤§åœé¡¿æ—¶é—´ç›®æ ‡
2. ååé‡ç›®æ ‡
3. æœ€å°çš„è¶³è¿¹ç›®æ ‡ï¼ˆå¯ç†è§£ä¸ºç¡¬ä»¶æ–¹é¢æ¶ˆè€—æ¯”å¦‚å †å¤§å°ï¼Ÿï¼‰


### 5.2.2. è°ƒä¼˜å‚æ•°

* æœ€å¤§åœé¡¿æ—¶é—´è®¾ç½®ï¼Œé»˜è®¤ä¸é™åˆ¶.ä¸€æ—¦è¯¥å‚æ•°è®¾å®šï¼Œå…¶ä»–å †å¤§å°å’Œåƒåœ¾å›æ”¶ç›¸å…³çš„å‚æ•°å°†è¢«è°ƒæ•´ä»¥å°è¯•å°†åƒåœ¾å›æ”¶å¯¼è‡´çš„åœé¡¿æ—¶é—´å°‘äºè¯¥æŒ‡å®šå€¼ã€‚è¯¥å€¼çš„è®¾å®šå¯èƒ½ä¼šå‡å°‘åº”ç”¨ååï¼Œå¦å¤–æŸäº›æƒ…å†µä¸‹æš‚åœæ—¶é—´å¹¶ä¸ä¸€å®šèƒ½è¾¾åˆ°è®¾å®šã€‚
    > -XX:MaxGCPauseMillis=\<N>

* è®¾ç½®åƒåœ¾å›æ”¶æ—¶é—´å æ¯”.è¯¥å€¼ä¸ºéåƒåœ¾å›æ”¶æ—¶é—´/åƒåœ¾å›æ”¶æ—¶é—´ï¼Œé»˜è®¤ä¸º99ï¼Œå³åƒåœ¾å›æ”¶æ—¶é—´å æ€»æ—¶é—´çš„1%ã€‚
    > -XX:GCTimeRatio=\<N>,

* CMSæ”¶é›†å™¨è®¾ç½®å¯åŠ¨åƒåœ¾å›æ”¶ç­–ç•¥ï¼šå¹´è€ä»£ä¸­çš„ç©ºé—´å ç”¨è¶…è¿‡æŸç™¾åˆ†æ¯”ï¼ŒæŒ‡å®šæ–¹å¼å¦‚ä¸‹ï¼š
    >-XX:CMSInitiatingOccupancyFraction=\<N>


* è°ƒå †ç©ºé—´å„ä¸ªå­éƒ¨åˆ†è°ƒèŠ‚å‚æ•°è§æœ¬ç¬”è®°å¸¸ç”¨å‘½ä»¤åŠå‚æ•°ã€‚é™¤äº†è¿™äº›å‚æ•°ï¼Œè¿˜å¯ä»¥è®¾ç½®æ¯ä»£çš„ç©ºé—´å¢é•¿æ­¥é•¿è¿›è¡Œè®¾ç½®ï¼ˆäº†è§£å³å¯ï¼‰ã€‚å¦‚ä¸‹ï¼š
    > -XX:YoungGenerationSizeIncrement=\<Y>

    > -XX:TenuredGenerationSizeIncrement=\<T>

    > -XX:AdaptiveSizeDecrementScaleFactor=\<D>

### 5.2.3. åº”ç”¨å¼‚å¸¸ç°è±¡åŠé—®é¢˜åŸå› 
* **OutOfMemoryError å †ç©ºé—´æº¢å‡º**
å½“è¶…è¿‡98%çš„æ—¶é—´ç”¨äºåƒåœ¾å›æ”¶å’Œå°‘äº2%çš„å †ç©ºé—´è¢«æ¢å¤ï¼Œè¯¥å¼‚å¸¸å°†æŠ›å‡ºã€‚è¯¥ç‰¹æ€§ç”¨äºé˜»æ­¢ç¨‹åºæ— æ•ˆçš„è¿è¡Œï¼Œå¯ä»¥é€šè¿‡å‚æ•° **-XX:-UseGCOverheadLimit**å¯¹è¯¥ç­–ç•¥è¿›è¡Œå…³é—­ã€‚ æ ¹æœ¬è§£å†³åŠæ³•æ˜¯ä¼˜åŒ–ç¨‹åºå¹¶è°ƒæ•´åˆç†çš„å†…å­˜ç©ºé—´ã€‚

* **Stop-The-World åƒåœ¾å›æ”¶æ—¶çš„åœé¡¿ç°è±¡**
åƒåœ¾å›æ”¶å™¨çš„ä»»åŠ¡æ˜¯è¯†åˆ«å’Œå›æ”¶åƒåœ¾å¯¹è±¡è¿›è¡Œå†…å­˜æ¸…ç†ï¼Œä¸ºäº†è®©åƒåœ¾å›æ”¶å™¨å¯ä»¥æ­£å¸¸ä¸”é«˜æ•ˆçš„æ‰§è¡Œï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¼šè¦æ±‚ç³»ç»Ÿè¿›å…¥ä¸€ä¸ªåœé¡¿çš„çŠ¶æ€ï¼Œç»ˆæ­¢æ‰€æœ‰åº”ç”¨ç¨‹åºçº¿ç¨‹çš„æ‰§è¡Œï¼Œä½¿ç³»ç»Ÿä¸ä¼šæœ‰æ–°çš„åƒåœ¾äº§ç”Ÿï¼ŒåŒæ—¶ä¿è¯ç³»ç»Ÿåœ¨æŸä¸€ä¸ªç¬é—´çš„ä¸€è‡´æ€§ï¼Œä¹Ÿæœ‰ç›Šäºåƒåœ¾å›æ”¶å™¨æ›´å¥½çš„æ ‡è®°åƒåœ¾å¯¹è±¡ï¼Œå› æ­¤åƒåœ¾å›æ”¶æ—¶éƒ½ä¼šäº§ç”Ÿåº”ç”¨ç¨‹åºçš„åœé¡¿ï¼Œåœé¡¿äº§ç”Ÿæ—¶æ•´ä¸ªåº”ç”¨è¢«å¡æ­»æ²¡æœ‰ä»»ä½•å“åº”ï¼Œè¿™ä¸ªåœé¡¿ä¹Ÿå«åšStop-The-World

# 6. åˆ†æjavaå †åŠæ€§èƒ½ç›‘æ§

## 6.1. å†…å­˜æº¢å‡º OOM
* å †æº¢å‡º
* ç›´æ¥å†…å­˜æº¢å‡º
* è¿‡å¤šçº¿ç¨‹å¯¼è‡´OOM
çº¿ç¨‹çš„å¼€å¯ä¼šå ç”¨ç³»ç»Ÿå†…å­˜ï¼Œå› æ­¤å½“çº¿ç¨‹æ•°é‡å¤ªå¤šæ—¶ä¹Ÿæœ‰å¯èƒ½å¯¼è‡´OOMã€‚çº¿ç¨‹çš„æ ˆç©ºé—´ä¹Ÿæ˜¯åœ¨å †å¤–åˆ†é…åˆ°ï¼Œå› æ­¤ä¸ç›´æ¥å†…å­˜éå¸¸ç›¸ä¼¼ï¼Œå¦‚æœæƒ³è®©ç³»ç»Ÿæ”¯æŒæ›´å¤šçš„çº¿ç¨‹ï¼Œé‚£ä¹ˆåº”è¯¥ä½¿ç”¨ä¸€ä¸ªè¾ƒå°çš„å †ç©ºé—´ã€‚è¿˜æœ‰å¦ä¸€ç§æ–¹å¼æ˜¯æŒ‡å®šçº¿ç¨‹çš„æ ˆç©ºé—´ã€‚
* æ°¸ä¹…åŒºæº¢å‡ºã€‚
* GCæ•ˆç‡ä½ä¸‹å¼•èµ·OOM,è™šæ‹Ÿæœºæ£€æŸ¥å¦‚ä¸‹æ¡ä»¶éƒ½æ»¡è¶³æ—¶ä¼šæŠ¥å‡ºOOM:
    * èŠ±åœ¨GCä¸Šçš„æ—¶é—´æ˜¯å¦è¶…è¿‡äº†98%
    * è€å¹´ä»£é‡Šæ”¾åˆ°å†…å­˜æ˜¯å¦å°äº2%
    * edenåŒºé‡Šæ”¾åˆ°å†…å­˜æ˜¯å¦å°äº2%
    * æ˜¯å¦è¿ç»­æœ€è¿‘5æ¬¡GCéƒ½å‡ºç°ä¸Šè¿°å‡ ç§æƒ…å†µã€‚
    å…·ä½“å¼‚å¸¸å†…å®¹ä¸ºï¼š
        > java.lang.OutOfMemoryError: GC overhead limit exceeded
        
## 6.2. ç›‘æ§å‘½ä»¤
* top å®æ—¶æ˜¾ç¤ºä¸ªè¿›ç¨‹èµ„æºå ç”¨åŠç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯
* vmstat æŸ¥çœ‹å†…å­˜ã€äº¤äº’åˆ†åŒºã€I/Oæ“ä½œã€ä¸Šä¸‹æ–‡åˆ‡æ¢ã€æ—¶é’Ÿä¸­æ–­ä»¥åŠCPUä½¿ç”¨æƒ…å†µ
* iostat ioç›‘æ§
* pidstat å¯ä»¥ç›‘è§† **è¿›ç¨‹** å’Œ **çº¿ç¨‹** çš„æ€§èƒ½(å†…å­˜ã€cpuã€ioç­‰)æƒ…å†µï¼Œç»“åˆjstackå¯ä»¥å¾ˆå¿«ç­‰æŸ¥å¤„ç›¸å…³æ€§èƒ½é—®é¢˜ä»£ç 

ç¤ºä¾‹ï¼šæŸ¥çœ‹è¿›ç¨‹å·ä¸º1108çš„cpuä½¿ç”¨æƒ…å†µï¼Œå¹¶è¯¦ç»†æ˜¾ç¤ºå…¶çº¿ç¨‹ã€‚
> pidstat -p 1108 1 5 -u -t 

* jstack æŸ¥çœ‹javaåº”ç”¨ç¨‹åºä¸‹æ‰€æœ‰çº¿ç¨‹
>jstack -l pid

## 6.3. jdkæ€§èƒ½ç›‘æ§å·¥å…·
* jps æ˜¾ç¤ºå½“å‰æ‰€æœ‰javaè¿›ç¨‹çš„ç›¸å…³ä¿¡æ¯
    > jps -q  åªæ˜¾ç¤ºè¿›ç¨‹id

    > jps -m è¾“å…¥ä¼ é€’ç»™javaè¿›ç¨‹ï¼ˆä¸»å‡½æ•°ï¼‰çš„å‚æ•°

    > jps -l è¾“å‡ºä¸»å‡½æ•°çš„å®Œæ•´è·¯å¾„

    > jps -v æ˜¾ç¤ºä¼ é€’ç»™javaè™šæ‹Ÿæœºçš„å‚æ•°

* jstat ç”¨äºè§‚å¯Ÿjavaåº”ç”¨ç¨‹åºè¿è¡Œæ—¶ç›¸å…³ä¿¡æ¯çš„å·¥å…·ï¼Œæå…¶å¼ºå¤§ã€‚

* jinfo æŸ¥çœ‹è™šæ‹Ÿæœºå‚æ•°

* **jmap** å¯¼å‡ºå †ä¿¡æ¯åˆ°æ–‡ä»¶

    > jmap -histo 2792 > ./map.txt  ç”Ÿæˆè¿›ç¨‹å·2972çš„javaç¨‹åºçš„å¯¹è±¡ç»Ÿè®¡ä¿¡æ¯å¹¶è¾“å‡ºåˆ°map.txt

    > jmap -dump:format=b,file=./heap.hprof 2792 å¯¼å‡ºè¿›ç¨‹ä¸º2972çš„å †å¿«ç…§åˆ°heap.hprof,å¯ç”¨äºè¿›è¡Œåˆ†æ

    > jmap -permstat 2792  æŸ¥çœ‹ç³»ç»Ÿçš„ClassLoaderä¿¡æ¯

    > jmap -finalizerinfo 2792   æŸ¥çœ‹ç³»ç»Ÿfinalizeré˜Ÿåˆ—ä¸­çš„å¯¹è±¡

* jhat åˆ†æjavaåº”ç”¨ç¨‹åºå †å¿«ç…§å†…å®¹
    > jhat ./heap.hprof åˆ†æå®Œæˆåè®¿é—® http://127.0.0.1:7000 å¯ä»¥æŸ¥çœ‹ç›¸å…³åˆ†æç»“æœä¿¡æ¯

* jstackæŸ¥çœ‹çº¿ç¨‹å †æ ˆ
    > jstack -l pid  å‚æ•°lç”¨äºè¾“å‡ºé”ç›¸å…³ä¿¡æ¯

* jstatd è¿œç¨‹ä¸»æœºä¿¡æ¯æ”¶é›†ã€‚å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªä»£ç†æœåŠ¡ï¼ŒæœåŠ¡å¯åŠ¨åä¸€äº›æœ¬åœ°å‘½ä»¤å¯ä»¥æ”¶é›†è¿œç¨‹ä¸»æœºçš„ä¿¡æ¯

* jcmd (from 1.7) å¤šåŠŸèƒ½å·¥å…·ï¼Œå¯ä»¥ç”¨å®ƒæ¥å¯¼å‡ºå †ã€æŸ¥çœ‹javaè¿›ç¨‹ã€å¯¼å‡ºçº¿ç¨‹ä¿¡æ¯ã€æ‰§è¡ŒGC

    > jcmd -l åˆ—å‡ºå½“å‰ç³»ç»Ÿä¸­çš„æ‰€æœ‰javaè™šæ‹Ÿæœº

    > jcmd pid help åˆ—å‡ºæŒ‡å®šè™šæ‹Ÿæœºæ‰€æ”¯æŒçš„å‘½ä»¤

    ```
    ~$ jcmd 4835 help
    e
    4835:
    The following commands are available:
    JFR.stop
    JFR.start
    JFR.dump
    JFR.check
    VM.native_memory
    VM.check_commercial_features
    VM.unlock_commercial_features
    ManagementAgent.stop
    ManagementAgent.start_local
    ManagementAgent.start
    GC.rotate_log
    Thread.print
    GC.class_stats
    GC.class_histogram
    GC.heap_dump
    GC.run_finalization
    GC.run
    VM.uptime
    VM.flags
    VM.system_properties
    VM.command_line
    VM.version
    help
    ```

* hprof æ€§èƒ½ç»Ÿè®¡å·¥å…·ï¼Œéç‹¬ç«‹ç›‘æ§å·¥å…·ï¼Œåªæ˜¯ä¸€ä¸ªjava agentå·¥å…·ã€‚ä½¿ç”¨è¯¥å·¥å…·å¯ä»¥æŸ¥çœ‹å„ä¸ªå‡½æ•°çš„CPUå ç”¨æ—¶é—´

    > java -agentlib:hprof=help æŸ¥çœ‹hprofçš„å¸®åŠ©æ–‡æ¡£

## 6.4. å›¾å½¢åŒ–ç›‘æ§å·¥å…·

* JConsole æŸ¥çœ‹åº”ç”¨ç¨‹åºæƒ…å†µï¼ŒåŒ…æ‹¬å †å†…å­˜ä½¿ç”¨æƒ…å†µã€ç³»ç»Ÿçº¿ç¨‹æ•°é‡ã€åŠ è½½ç±»çš„æ•°é‡åŠCPUä½¿ç”¨ç‡,è™šæ‹Ÿæœºå‚æ•°ï¼Œæ£€æµ‹æ­»é”ç­‰ã€‚
    * è¯¥å·¥å…·åœ¨javahomeçš„binç›®å½•ä¸‹

* Visual VM åŠŸèƒ½å¼ºå¤§ç­‰å¤šåˆä¸€æ•…éšœè¯Šæ–­å’Œæ€§èƒ½ç›‘æ§çš„å¯è§†åŒ–å·¥å…·ï¼Œå¯ä»¥æ›¿ä»£jstatã€jmapã€jhatã€jstackå‡è‡³JConsoleï¼Œæ”¯æŒå„ç±»æ’ä»¶æ‰©å±•

* MAT ç®€å•æ˜“ç”¨ï¼Œé’ˆå¯¹æ€§å¼ºã€‚

## 6.5. å¤§æ€å™¨arthas
**arthasçš„åŠŸèƒ½**
* è¿™ä¸ªç±»ä»å“ªä¸ª jar åŒ…åŠ è½½çš„ï¼Ÿä¸ºä»€ä¹ˆä¼šæŠ¥å„ç§ç±»ç›¸å…³çš„ Exceptionï¼Ÿ
* æˆ‘æ”¹çš„ä»£ç ä¸ºä»€ä¹ˆæ²¡æœ‰æ‰§è¡Œåˆ°ï¼Ÿéš¾é“æ˜¯æˆ‘æ²¡ commitï¼Ÿåˆ†æ”¯æé”™äº†ï¼Ÿ
* é‡åˆ°é—®é¢˜æ— æ³•åœ¨çº¿ä¸Š debugï¼Œéš¾é“åªèƒ½é€šè¿‡åŠ æ—¥å¿—å†é‡æ–°å‘å¸ƒå—ï¼Ÿ
* çº¿ä¸Šé‡åˆ°æŸä¸ªç”¨æˆ·çš„æ•°æ®å¤„ç†æœ‰é—®é¢˜ï¼Œä½†çº¿ä¸ŠåŒæ ·æ— æ³• debugï¼Œçº¿ä¸‹æ— æ³•é‡ç°ï¼
* æ˜¯å¦æœ‰ä¸€ä¸ªå…¨å±€è§†è§’æ¥æŸ¥çœ‹ç³»ç»Ÿçš„è¿è¡ŒçŠ¶å†µï¼Ÿ
* æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥ç›‘æ§åˆ°JVMçš„å®æ—¶è¿è¡ŒçŠ¶æ€ï¼Ÿ
* æ€ä¹ˆå¿«é€Ÿå®šä½åº”ç”¨çš„çƒ­ç‚¹ï¼Œç”Ÿæˆç«ç„°å›¾ï¼Ÿ

[arthaså®˜æ–¹æ–‡æ¡£](https://alibaba.github.io/arthas/)

# 7. é”

## 7.1. é”çš„åŸºæœ¬æ¦‚å¿µå’Œå®ç°
å®‰å…¨æ˜¯é”å­˜åœ¨çš„ç†ç”±ï¼Œå…¶ä½œç”¨æ˜¯ä¿æŠ¤ä¸´ç•ŒåŒºèµ„æºä¸ä¼šè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®è€Œæ”¶åˆ°ç ´åã€‚
* çº¿ç¨‹å®‰å…¨
* å¯¹è±¡å¤´å’Œé”
    åœ¨javaè™šæ‹Ÿæœºçš„å®ç°ä¸­æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå¯¹è±¡å¤´ï¼Œç”¨äºä¿å­˜å¯¹è±¡çš„ç³»ç»Ÿä¿¡æ¯ï¼Œå¯¹è±¡å¤´ä¸­æœ‰ä¸€ä¸ªç§°ä¸ºMark Wordçš„éƒ¨åˆ†ï¼Œå®ƒæ˜¯å®ç°é”çš„å…³é”®ã€‚åœ¨32ä½æ“ä½œç³»ç»Ÿä¸­MarkWorkå 32ä½ï¼Œ64ä½æ“ä½œç³»ç»Ÿä¸­å 64ä½ã€‚MarkWordä¸­è®°å½•äº†ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å ç”¨é”ï¼Œå æœ‰å“ªä¸ªé”

## 7.2. javaè™šæ‹Ÿæœºä¸­é”å®ç°åŠä¼˜åŒ–

### 7.2.1. åå‘é”
* jdk1.6åæå‡ºçš„ä¸€ç§ä¼˜åŒ–é”æ–¹å¼ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœç¨‹åºæ²¡æœ‰ç«äº‰ï¼Œåˆ™å–æ¶ˆä¹‹å‰å·²ç»å–å¾—é”çš„çº¿ç¨‹åŒæ­¥æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´æŸä¸€ä¸ªé”è¢«çº¿ç¨‹è·å–åï¼Œä¾¿è¿›å…¥åå‘æ¨¡å¼ï¼Œå½“çº¿ç¨‹å†æ¬¡è¯·æ±‚è¿™ä¸ªé”æ—¶æ— éœ€å†è¿›è¡Œç›¸å…³åŒæ­¥æ“ä½œã€‚ä½¿ç”¨ **-XX:+UseBiasedLocking**è®¾ç½®å¯ç”¨åå‘é”ã€‚
* åå‘é”åœ¨ç«äº‰æ¿€çƒˆçš„åœºåˆæ²¡æœ‰å¤ªå¼ºçš„ä¼˜åŒ–æ•ˆæœï¼Œå› ä¸ºå¤§é‡çš„ç«äº‰ä¼šå¯¼è‡´æŒæœ‰é”çš„çº¿ç¨‹ä¸åœçš„åˆ‡æ¢ï¼Œé”ä¹Ÿå¾ˆéš¾ä¸€ç›´ä¿æŒåœ¨åå‘æ¨¡å¼ï¼Œæ­¤æ—¶åå‘é”ä¸ä»…å¾—ä¸åˆ°æ€§èƒ½ä¼˜åŒ–ï¼Œåè€Œæœ‰å¯èƒ½é™ä½ç³»ç»Ÿæ€§èƒ½ã€‚å¯ä»¥ä½¿ç”¨ **-XX:-UseBiasedLocking**å‚æ•°ç¦ç”¨åå‘é”ã€‚

### 7.2.2. è½»é‡çº§é”
* åå‘é”è·å–å¤±è´¥åè·å–è¯¥é”ã€‚
* è¯¥é”æ˜¯åŸºäºæ”¾ç½®åœ¨javaçº¿ç¨‹æ ˆä¸­çš„å¯¹è±¡BasicObjectLockå®ç°çš„ã€‚å½“ä½¿ç”¨è½»é‡çº§é”æ—¶å¯¹è±¡å¤´éƒ¨çš„Mark Wordä¸ºæŒ‡å‘BasicLockçš„å¯¹è±¡çš„æŒ‡é’ˆï¼Œå½“åˆ¤æ–­æŸä¸€å¯¹è±¡æ˜¯å¦æŒæœ‰è¯¥å¯¹è±¡é”æ—¶åªéœ€è¦ç®€å•çš„åˆ¤æ–­å¯¹è±¡å¤´çš„æŒ‡é’ˆæ˜¯å¦åœ¨å½“å‰çº¿ç¨‹çš„æ ˆåœ°å€èŒƒå›´å³å¯ï¼ˆBasicObjectLockæŒæœ‰ä¸€ä¸ªBasicLockå¯¹è±¡ï¼‰ã€‚
* åŠ é”æ–¹å¼ï¼šBasicLockå¤‡ä»½äº†åŸå¯¹è±¡çš„Mark Wordï¼Œé€šè¿‡ä½¿ç”¨ **CAS**æ“ä½œå°è¯•å°†BasicLockçš„åœ°å€å¤åˆ¶åˆ°å¯¹è±¡å¤´çš„Mark Wordï¼Œå¦‚æœå¤åˆ¶æˆåŠŸï¼Œé‚£ä¹ˆåŠ é”æˆåŠŸï¼Œå¦åˆ™è®¤ä¸ºåŠ é”å¤±è´¥ã€‚å¦‚æœåŠ é”å¤±è´¥é‚£ä¹ˆå°±æœ‰å¯èƒ½è¢«è†¨èƒ€ä¸ºé‡é‡çº§é”ã€‚
### 7.2.3. é”è†¨èƒ€
å½“è½»é‡çº§é”è·å–å¤±è´¥ï¼Œè™šæ‹Ÿæœºå°±ä¼šä½¿ç”¨é‡é‡çº§é”ï¼Œæ‰§è¡Œæ“ä½œåˆ†ä¸ºä¸¤æ­¥ï¼š
1. åºŸå¼ƒBasicLockå¤‡ä»½çš„å¯¹è±¡å¤´ä¿¡æ¯
2. æ­£å¼å¯ç”¨é‡é‡çº§é”
    1> é€šè¿‡inflateæ–¹æ³•è¿›è¡Œé”è†¨èƒ€ï¼Œè·å¾—å¯¹è±¡çš„ObjectMonitor
    2> ä½¿ç”¨enteræ–¹æ³•å°è¯•è¿›å…¥è¯¥é”ã€‚åœ¨enteræ–¹æ³•ä¸­å¯èƒ½ä¼šåœ¨æ“ä½œç³»ç»Ÿå±‚é¢è¢«æŒ‚èµ·ï¼Œå¦‚æœè¿™æ ·çº¿ç¨‹åˆ‡æ¢å’Œè°ƒç”¨æˆæœ¬ä¼šæ¯”è¾ƒé«˜ï¼ˆä¼˜åŒ–è¯¥é—®é¢˜å…³æ³¨è‡ªæ—‹é”ï¼‰ã€‚
### 7.2.4. è‡ªæ—‹é”
* è‡ªæ—‹é”å¯ä»¥ä½¿çº¿ç¨‹åœ¨æ²¡æœ‰å–å¾—é”æ—¶ä¸è¢«æŒ‚èµ·ï¼Œè€Œè½¬è€Œå»æ‰§è¡Œä¸€ä¸ªç©ºå¾ªç¯ã€‚åœ¨è‹¥å¹²ä¸ªç©ºå¾ªç¯åçº¿ç¨‹å¦‚æœå¯ä»¥è·å¾—é”ï¼Œåˆ™ç»§ç»­æ‰§è¡Œã€‚è‹¥çº¿ç¨‹ä¾ç„¶ä¸èƒ½è·å¾—é”ï¼Œæ‰èƒ½è¢«æŒ‚èµ·ã€‚
* é€‚ç”¨åœºæ™¯ï¼šé”ç«äº‰ä¸æ˜¯å¾ˆæ¿€çƒˆä¸”é”å ç”¨æ—¶é—´å¾ˆçŸ­çš„å¹¶å‘çº¿ç¨‹ã€‚
* å¯ç”¨ã€‚ä½¿ç”¨ **-XX:+UseSpinning**,ä½¿ç”¨**-XX:PreBlockSpin**å‚æ•°è®¾ç½®è‡ªæ—‹é”çš„ç­‰å¾…æ¬¡æ•°ã€‚jdk1.7åè‡ªæ—‹é”å‚æ•°å–æ¶ˆï¼Œè‡ªæ—‹é”æ€»æ˜¯æ‰§è¡Œï¼Œè‡ªæ—‹æ¬¡æ•°ç”±è™šæ‹Ÿæœºè‡ªè¡Œè°ƒæ•´ã€‚
### 7.2.5. é”æ¶ˆé™¤
* é”æ¶ˆé™¤æ˜¯javaè™šæ‹Ÿæœºåœ¨JITç¼–è¯‘æ—¶é€šè¿‡å¯¹è¿è¡Œä¸Šä¸‹æ–‡æ‰«æï¼Œå»é™¤ä¸å¯èƒ½å­˜åœ¨å…±äº«èµ„æºç«äº‰çš„é”ã€‚é€šè¿‡é”æ¶ˆé™¤èŠ‚çœæ¯«æ— æ„ä¹‰çš„è¯·æ±‚é”æ—¶é—´ã€‚æ¯”å¦‚æ–¹æ³•ä¸­ä½¿ç”¨äº†çº¿ç¨‹å®‰å…¨çš„å·¥å…·ç±»ï¼Œå¦‚Vector
* é€ƒé€¸åˆ†æå’Œé”æ¶ˆé™¤å¯ä»¥ä½¿ç”¨å‚æ•° **+XX:DoEscapeAnalysis** å’Œ **-XX:+EliminateLocks**å¼€å¯ï¼Œä½†æ˜¯å¿…é¡»å·¥ä½œåœ¨serveræ¨¡å¼ä¸‹ã€‚å‚è€ƒå‚æ•°:
    > -server -XX:+XX:DoEscapeAnalysis -XX:+EliminateLocks -Xcomp -XX:-BackgroundCompilation -XX:BiasedLockingStartupDelay=0

### 7.2.6. åº”ç”¨çº§åˆ«é”ä¼˜åŒ–

* å‡å°‘é”æŒæœ‰çš„æ—¶é—´ï¼Œæ¯”å¦‚ä»…å¯¹å­˜åœ¨ç«äº‰çš„ä»£ç å—è¿›è¡ŒåŠ é”ã€‚
* è§å‡å°é”ç²’åº¦ã€‚
    å‚è€ƒConcurrentHashMapï¼Œå…¶å°†æ•´ä¸ªHashMapåˆ†æˆè‹¥å¹²ä¸ªæ®µï¼ˆSegment    ï¼‰ï¼Œå½“è¿›è¡Œæ’å…¥æˆ–è·å–æ•°æ®æ—¶ä»…å¯¹æ“ä½œçš„æ®µè¿›è¡ŒåŠ é”ã€‚
* é”åˆ†ç¦»ï¼Œå‡å°é”åŠ›åº¦çš„ç‰¹ä¾‹ã€‚
    ä¾æ®åº”ç”¨ç¨‹åºçš„åŠŸèƒ½ç‰¹ç‚¹å°†ä¸€ä¸ªç‹¬å é”åˆ†æˆå¤šä¸ªé”ã€‚å‚è€ƒLinkedBlockingQueueçš„å®ç°ï¼Œç”±äºtakeå’Œputæ“ä½œåˆ†åˆ«ä½œç”¨äºé˜Ÿåˆ—çš„å‰ç«¯å’Œåç«¯ï¼Œä¸¤è€…å¹¶ä¸å†²çªï¼Œæ‰€ä»¥åˆ†åˆ«åŠ é”ã€‚
* é”ç²—åŒ–
    åŒä¸€ä¸ªé”ä¸åœçš„è¯·æ±‚ã€åŒæ­¥å’Œé‡Šæ”¾æœ¬èº«ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œæ‰€ä»¥åœ¨ä¸€ä¸ªæ•´å—é€»è¾‘ä¸­ç©¿æ’ä¸æ˜¯å¤ªè€—æ—¶çš„ä»£ç å—ä¹Ÿæ˜¯åˆç†çš„ï¼Œä¸å¿…ä¸ºäº†å‡å°‘é”æŒæœ‰æ—¶é—´åˆ†ä¸ºå¤šæ¬¡é”ã€‚
* æ— é”
    * CAS(compare and swap)
    * åŸå­æ“ä½œ
    * LongAddr
### 7.2.7. javaå†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰
* åŸå­æ€§
* æœ‰åºæ€§
* å¯è§è¡Œ
* Happens-BeforeåŸåˆ™
    
        
# 8. å‚è€ƒèµ„æ–™
* ğŸ‘‰ ã€å®æˆ˜javaè™šæ‹Ÿæœº jvmæ•…éšœè¯Šæ–­åŠæ€§èƒ½è°ƒä¼˜ã€‘  è‘›ä¸€é¸£
* ğŸ‘‰ ã€å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ ã€‘ æ–¹è…¾é£ é­é¹ ç¨‹æ™“æ˜è‘—
* ğŸ‘‰ [åƒåœ¾å›æ”¶å™¨ä½¿ç”¨å‚è€ƒèµ„æ–™](https://www.oracle.com/technetwork/java/javase/gc-tuning-6-140523.html#available_collectors.selecting)
* ğŸ‘‰  [oracleå®˜æ–¹å®Œæ•´é…ç½®å‚æ•°](https://www.oracle.com/technetwork/articles/java/vmoptions-jsp-140102.html)
* ğŸ‘‰  [ç¾å›¢åƒåœ¾å›æ”¶åŠä¼˜åŒ–å‚è€ƒèµ„æ–™](https://tech.meituan.com/2017/12/29/jvm-optimize.html)
* ğŸ‘‰ [é»˜è®¤åƒåœ¾å›æ”¶å™¨](https://www.javamadesoeasy.com/2016/12/what-is-default-garbage-collector-for.html)