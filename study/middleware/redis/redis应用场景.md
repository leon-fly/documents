---
date: "2018-01-01"
draft: false
lastmod: "2018-01-01"
publishdate: "2018-01-01"
tags:
- middleware
- redis
title: redis经典使用场景
---
## 1. 分布式锁
* 实现方式
    * watch实现事务。简单，但是事务性能比较低，当并发比较高时，出现重试的次数较多，浪费计算机资源
    * 通过setnx实现事务。推荐的分布式事务实现方式。
* 锁实现注意事项
    * 性能
    * 客户端获取锁后崩溃引起的锁无法释放问题
        * 使用键超时（expires命令） 
        * 使用超时后，如果超时客户端未执行完成相关操作怎么办？ TDOO

## 2. 计数信号量
* 计数信号量是对有限资源使用限制的支持，比如某资源仅允许同时被5个线程访问，如何限制可以通过计数信号量的方式来处理。
* 技术实现基于有序集合的基本实现
    * 基本原理：以资源名称作为键，客户端请求时使用uuid作为唯一表示，unix时间戳作为分数，以分数排名，排名在资源允许的访问数之内的即为有效，之外的未获取到资源。
    * 非公平信号量
        * 当有多台机器时，如果各及其的时钟不同，时钟慢的可能总会优先获得信号量，时钟快的可能存在一直拿不到信号量的情况以及信号量提早过期。
        * 解决方法：
            * 各个系统之间时间差调整不超过1秒，以上问题会得到好的规避。
            * 统一使用redis服务器的时间
    * 信号量更新
        * 当信号量超过过期时间将被删除，长时间使用信号量时为了避免被删除需要频繁更新信号量。
    * 注意事项：
        * 客户端在获取锁的第一步是清理过期的信号量持有者
        * 在判断获取失败后需要删除之前添加的标识符
        * 使用完信号量后需要及时释放
        * 消除竞争条件消除
            * 由于计数信号量的获取需要多步操作，可能出现时间戳虽然在前面但是在后面插入有序集合中的造成不正常的信号量获取和释放，所以需要使用分布式锁锁定来控制信号量获取时的并发问题。
## 3. 缓存


待续... 