---
date: "2020-04-22"
draft: false
lastmod: "2020-04-22"
publishdate: "2020-04-22"
tags:
- middleware
- mq
- rabbitmq
title: rabbitmq-监控
---

# 如何做好rabbitmq监控

## 1. 监控要点

监控的目标是保证系统的稳定，系统出现可能导致不可用的因素时进行告警。那么rabbitmq要关注哪些内容呢？除了硬件层面的监控（如cpu、内存等通用监控）外罗列核心点如下：

* 单机指标监控
    * 队列消息总数，未确认消息数（可以根据压力测试情况设定合理的阀值）
    * 私信队列消息关注（根据业务是否使用私信来具体处理）
* 配置监控
    * 队列持久化选项检查（避免重要业务在故障后才发现数据丢失）
* 集群状态监控
    * 集群节点健康检测
        使用AMQP ping进行检测，而不是仅检测其端口
    * 集群主节点发生转移及恢复检测

## 2. 监控需要使用到的工具

* rabbitmq提供的服务rest api
    * /api/avliveness-test/\<vhost>  内部检测rabbitmq服务器健康状态的api。它使用三个步骤来验证rabbit服务器是否健康：
        1. 创建一个队列来接收测试消息
        2. 用队列名称作为消息路由键将消息发往默认的交换器
        3. 当消息到达队列时消费该消息，否则就报错。
    * /api/queues/\<vhost>/\<queue> 查看队列的配置详情及数据统计
    * /api/exchanges/\<vhost>/\<exchange> 查看交换器的配置详情及数据统计
    * /api/nodes  集群节点信息获取
* 监控告警工具 如nagios
    通过rest api采集服务信息发送到监控平台，并设定相关告警阀值。