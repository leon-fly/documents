---
date: "2020-03-26"
draft: false
lastmod: "2020-03-26"
publishdate: "2020-03-26"
categorys:
- ä¸­é—´é”®
tags:
- db
- mysql
- optimize
title: mysql explain
---
## 1. å…³äºmysql explain
* explainæ˜¯mysqlæä¾›çš„ç”¨äºæŸ¥çœ‹å¯¹äºä¸€æ¡sqlè¯­å¥mysqlçš„æ‰§è¡Œè®¡åˆ’ï¼Œæ¯”å¦‚æŸ¥è¯¢æ¬¡æ•°ï¼ŒæŸ¥è¯¢æ˜¯å¦ä½¿ç”¨ç´¢å¼•ï¼Œé¢„æœŸæ‰«æè¡Œæ•°ç­‰ç­‰ï¼Œå¯ä»¥ä½¿ç”¨è¯¥å·¥å…·è¿›è¡Œmysqlä¼˜åŒ–ã€‚

* ä½¿ç”¨æ–¹æ³•ï¼šåœ¨selectè¯­å¥å‰åŠ explainã€‚

ä»¥ä¸‹ä¸ºä¸€ä¸ªç®€å•çš„ä½¿ç”¨ç´¢å¼•æŸ¥è¯¢çš„è§£é‡Šè®¡åˆ’ï¼š
```
mysql> EXPLAIN SELECT * FROM employees t WHERE t.`emp_no`='10001';
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref   | rows | filtered | Extra |
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
|  1 | SIMPLE      | t     | NULL       | const | PRIMARY       | PRIMARY | 4       | const |    1 |   100.00 | NULL  |
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
1 row in set, 1 warning (0.00 sec)
```

## 2. explainç»“æœå„ä¸ªæ•°æ®é¡¹è¯¦è§£
### 2.1. æ•°æ®è¡Œ
explainç»“æœå¯èƒ½ä¼šå‡ºç°å¤šè¡Œæœ‰åºæ•°æ®ï¼Œè¡¨ç¤ºæ‰§è¡Œæ‰€éœ€è¦çš„æŸ¥è¯¢æ¬¡æ•°åŠæ¬¡åºã€‚æ¯”å¦‚åœ¨æ¶‰åŠå­æŸ¥è¯¢ã€unionç­‰æ“ä½œæ—¶ã€‚

ç¤ºä¾‹1ï¼š
```
mysql> EXPLAIN SELECT t.*,e.* FROM employees t LEFT JOIN dept_emp e ON t.`emp_no`=e.`emp_no`;
+----+-------------+-------+------------+------+----------------+--------+---------+--------------------+--------+----------+-------------+
| id | select_type | table | partitions | type | possible_keys  | key    | key_len | ref                | rows   | filtered | Extra       |
+----+-------------+-------+------------+------+----------------+--------+---------+--------------------+--------+----------+-------------+
|  1 | SIMPLE      | t     | NULL       | ALL  | NULL           | NULL   | NULL    | NULL               | 299343 |   100.00 | NULL        |
|  1 | SIMPLE      | e     | NULL       | ref  | PRIMARY,emp_no | emp_no | 4       | employees.t.emp_no |      1 |   100.00 | Using index |
+----+-------------+-------+------------+------+----------------+--------+---------+--------------------+--------+----------+-------------+
```

ç¤ºä¾‹2 
å½“ä½¿ç”¨unionæ—¶ä¼šæœ‰é¢å¤–çš„è¡Œä¿¡æ¯ï¼š
```
EXPLAIN SELECT 1 UNION SELECT 1;
+----+--------------+------------+------------+------+---------------+------+---------+------+------+----------+-----------------+
|  id  | select_type  | table      | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra           |
+------+--------------+------------+------------+------+---------------+------+---------+------+------+----------+-----------------+
|  1   | PRIMARY      | NULL       | NULL       | NULL | NULL          | NULL | NULL    | NULL | NULL |     NULL | No tables used  |
|  2   | UNION        | NULL       | NULL       | NULL | NULL          | NULL | NULL    | NULL | NULL |     NULL | No tables used  |
| NULL | UNION RESULT | <union1,2> | NULL       | ALL  | NULL          | NULL | NULL    | NULL | NULL |     NULL | Using temporary |
+----+--------------+------------+------------+------+---------------+------+---------+------+------+----------+-----------------+
```

ä½¿ç”¨union allä¸åŒäºunionï¼Œunionä¸äº§ç”Ÿä¸´æ—¶è¡¨
```
mysql> mysql> EXPLAIN SELECT 1 UNION ALL SELECT 1;
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------+
| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra          |
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------+
|  1 | PRIMARY     | NULL  | NULL       | NULL | NULL          | NULL | NULL    | NULL | NULL |     NULL | No tables used |
|  2 | UNION       | NULL  | NULL       | NULL | NULL          | NULL | NULL    | NULL | NULL |     NULL | No tables used |
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------+
```

### 2.2. æ•°æ®åˆ—
#### 2.2.1. id
å”¯ä¸€æ ‡è¯†sqlä¸­çš„æ¯ä¸€ä¸ªï¼ˆå­ï¼‰æŸ¥è¯¢ï¼Œå†…å±‚çš„selectè¯­å¥ä¸€èˆ¬ä¼šé¡ºåºç¼–å·ï¼Œå¯¹åº”äºå…¶åœ¨åŸå§‹è¯­å¥ä¸­çš„ä½ç½®ã€‚
#### 2.2.2. select_type
è¯¥åˆ—æ˜¾ç¤ºäº†å¯¹åº”è¡Œæ˜¯ç®€å•è¿˜æ˜¯å¤æ‚selectã€‚simpleä»£è¡¨åªæœ‰ç®€å•æŸ¥è¯¢ï¼Œä¸å«æœ‰å­æŸ¥è¯¢å’Œunionã€‚å¦‚æœæŸ¥è¯¢å«æœ‰ä»»ä½•å¤æ‚æŸ¥è¯¢åˆ™æœ€å¤–å±‚æŸ¥è¯¢ä¸ºprimaryï¼Œå…¶ä»–éƒ¨åˆ†æ ‡è®°ä¸ºå¦‚ä¸‹ï¼š
* SUBQUERY
åŒ…å«åœ¨selectçš„å±æ€§åˆ—è¡¨ä¸­selectæ ‡è®°ä¸ºSUBQUERY.SUBQUERYæœ‰å¾ˆå¤šæ´¾ç”Ÿç±»å‹

ç¤ºä¾‹ï¼š
```
EXPLAIN SELECT t.`emp_no`, (SELECT it.`first_name` FROM employees it WHERE t.`emp_no`=it.`emp_no` AND it.`emp_no`='10001' ) FROM employees t;
+----+--------------------+-------+------------+-------+---------------+------------------------+---------+-------+--------+----------+-------------+
| id | select_type        | table | partitions | type  | possible_keys | key                    | key_len | ref   | rows   | filtered | Extra       |
+----+--------------------+-------+------------+-------+---------------+------------------------+---------+-------+--------+----------+-------------+
|  1 | PRIMARY            | t     | NULL       | index | NULL          | ind_employees_birthday | 3       | NULL  | 299343 |   100.00 | Using index |
|  2 | DEPENDENT SUBQUERY | it    | NULL       | const | PRIMARY       | PRIMARY                | 4       | const |      1 |   100.00 | NULL        |
+----+--------------------+-------+------------+-------+---------------+------------------------+---------+-------+--------+----------+-------------+
```
* DERIVED
åŒ…å«åœ¨Fromå­å¥ä¸­çš„å­æŸ¥è¯¢ä¸­çš„selectï¼Œmysqlä¼šé€’å½’æ‰§è¡Œå¹¶å°†ç»“æœæ”¾åˆ°ä¸€ä¸ªä¸´æ—¶è¡¨ä¸­ï¼ŒæœåŠ¡å™¨å†…éƒ¨ç§°å…¶ä¸ºæ´¾ç”Ÿè¡¨ã€‚
ç¤ºä¾‹ï¼š

* UNION
åœ¨unionä¸­çš„ç¬¬äºŒä¸ªå’Œéšåçš„selectè¢«æ ‡è®°ä¸ºunion
* UNION RESULT
ç”¨æ¥ä»unionçš„åŒ¿åä¸´æ—¶è¡¨æ£€ç´¢ç»“æœçš„selectè¢«æ ‡è®°æˆ‘iunion result

#### 2.2.3. table
æ ‡è¯†å½“å‰è¡ŒæŸ¥è¯¢çš„è¡¨çš„åç§°æˆ–è¡¨çš„åˆ«åã€‚ç‰¹åˆ«çš„è¡¨æ˜ï¼šderivedNï¼Œè¡¨ç¤ºä¸ºå†…éƒ¨æŸ¥è¯¢åŒ¿åä¸´æ—¶è¡¨ï¼ŒNè¡¨ç¤ºå‘å‰å¼•ç”¨è®¡æ•°ï¼ŒNæŒ‡å‘EXPLAINè¾“å‡ºä¸­åé¢çš„ä¸€è¡Œã€‚

#### 2.2.4. partitions

æ ‡è¯†å½“å‰æŸ¥è¯¢çš„è¡¨æ˜¯å¦æ˜¯åˆ†åŒºè¡¨ã€‚

#### 2.2.5. type
è¯¥åˆ—æ˜¾ç¤ºè®¿é—®ç±»å‹ï¼Œä»æœ€å·®åˆ°æœ€ä¼˜ä¾æ¬¡ä¸ºï¼š
* ALL
å…¨è¡¨æ‰«æã€‚ä¾‹å¤–ï¼šå½“ä½¿ç”¨äº†limitæˆ–è€…Extraåˆ—ä¸­æ˜¾ç¤ºUsing distinct/not existsæ—¶ï¼Œéå…¨è¡¨æ‰«æã€‚
* index
è·Ÿå…¨è¡¨æ‰«æä¸€æ ·ï¼Œåªæ˜¯mysqlæ‰«æè¡¨æ—¶æŒ‰ç´¢å¼•æ¬¡åºè¿›è¡Œè€Œä¸æ˜¯è¡Œã€‚
* range
æœ‰é™åˆ¶çš„ç´¢å¼•æ‰«æï¼Œä¼˜äºå…¨ç´¢å¼•æ‰«æã€‚å…³é”®ä¿¡æ¯ï¼šç´¢å¼•+åŸºäºç´¢å¼•çš„èŒƒå›´æŸ¥æ‰¾
* ref
ç´¢å¼•è®¿é—®æˆ–è€…ç´¢å¼•æŸ¥æ‰¾ã€‚è¿”å›æ‰€æœ‰åŒ¹é…æŸä¸ªå•ä¸ªå€¼çš„è¡Œï¼Œå¯èƒ½æ‰¾åˆ°å¤šä¸ªç¬¦åˆæ¡ä»¶çš„è¡Œã€‚å…³é”®ä¿¡æ¯ï¼šéå”¯ä¸€ç´¢å¼•/å”¯ä¸€ç´¢å¼•çš„éå”¯ä¸€æ€§å‰ç¼€ + åŒ¹é…å•ä¸ªå€¼
ç¤ºä¾‹ï¼š
```
-- birth_dateå»ºç«‹äº†æ™®é€šç´¢å¼•
mysql> EXPLAIN SELECT * FROM employees t WHERE t.birth_date='1990-01-01';
+----+-------------+-------+------------+------+------------------------+------------------------+---------+-------+------+----------+-------+
| id | select_type | table | partitions | type | possible_keys          | key                    | key_len | ref   | rows | filtered | Extra |
+----+-------------+-------+------------+------+------------------------+------------------------+---------+-------+------+----------+-------+
|  1 | SIMPLE      | t     | NULL       | ref  | ind_employees_birthday | ind_employees_birthday | 3       | const |    1 |   100.00 | NULL  |
+----+-------------+-------+------------+------+------------------------+------------------------+---------+-------+------+----------+-------+
```
**ref_or_null**, refçš„å˜ä½“ï¼Œè¡¨ç¤ºmysqlå¿…é¡»åœ¨åˆæ¬¡æŸ¥æ‰¾çš„ç»“æœé‡Œè¿›è¡Œç¬¬äºŒæ¬¡æŸ¥æ‰¾ä»¥æ‰¾å‡ºNULLæ¡ç›®ã€‚
* eq_ref
mysqlçŸ¥é“æœ€å¤šè¿”å›ä¸€æ¡ç¬¦åˆæ¡ä»¶çš„è®°å½•ã€‚å…³é”®ä¿¡æ¯ï¼šä¸»é”®/å”¯ä¸€ç´¢å¼•+åŒ¹é…å•ä¸ªå€¼.
ç¤ºä¾‹ï¼š
```
-- emp_noä¸ºä¸»é”®
mysql> EXPLAIN SELECT * FROM employees t WHERE t.emp_no IN (SELECT emp_no FROM dept_emp WHERE dept_no='d005');
+----+-------------+----------+------------+--------+------------------------+---------+---------+---------------------------+--------+----------+-------------+
| id | select_type | table    | partitions | type   | possible_keys          | key     | key_len | ref                       | rows   | filtered | Extra       |
+----+-------------+----------+------------+--------+------------------------+---------+---------+---------------------------+--------+----------+-------------+
|  1 | SIMPLE      | dept_emp | NULL       | ref    | PRIMARY,emp_no,dept_no | dept_no | 12      | const                     | 148054 |   100.00 | Using index |
|  1 | SIMPLE      | t        | NULL       | eq_ref | PRIMARY                | PRIMARY | 4       | employees.dept_emp.emp_no |      1 |   100.00 | NULL        |
+----+-------------+----------+------------+--------+------------------------+---------+---------+---------------------------+--------+----------+-------------+
```

* const, system
å½“mysqlèƒ½å¯¹æŸ¥è¯¢åˆ°æŸéƒ¨åˆ†è¿›è¡Œä¼˜åŒ–å¹¶å°†å…¶è½¬æ¢æˆä¸€ä¸ªå¸¸é‡ï¼Œå°†ä¼šä½¿ç”¨è¯¥è®¿é—®ç±»å‹ã€‚

ç¤ºä¾‹
```
-- emp_noä¸ºä¸»é”®
mysql> EXPLAIN SELECT * FROM employees t WHERE t.emp_no='10001';
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref   | rows | filtered | Extra |
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
|  1 | SIMPLE      | t     | NULL       | const | PRIMARY       | PRIMARY | 4       | const |    1 |   100.00 | NULL  |
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
```

* NULL
è¿™ç§æ–¹å¼è¡¨ç¤ºmysqlèƒ½åœ¨ä¼˜åŒ–é˜¶æ®µåˆ†è§£æŸ¥è¯¢è¯­å¥ï¼Œåœ¨æ‰§è¡Œé˜¶æ®µç”šè‡³ç”¨ä¸ç€å†è®¿é—®æˆ–è€…ç´¢å¼•ã€‚

```
-- emp_noä¸ºä¸»é”®
EXPLAIN SELECT max(emp_no) FROM employees;
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+------------------------------+
| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                        |
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+------------------------------+
|  1 | SIMPLE      | NULL  | NULL       | NULL | NULL          | NULL | NULL    | NULL | NULL |     NULL | Select tables optimized away |
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+------------------------------+
```

#### 2.2.6. possible_keys
å¯èƒ½ä½¿ç”¨åˆ°å¯¹ç´¢å¼•ï¼Œåœ¨ä¼˜åŒ–æ—©æœŸåˆ›å»ºï¼Œæœ‰äº›åœ¨åç»­ä¼˜åŒ–è¿‡ç¨‹å¯èƒ½ç”¨ä¸åˆ°ã€‚

#### 2.2.7. key
mysqlå®é™…ä½¿ç”¨å¯¹ç´¢å¼•ï¼Œè¯¥å€¼ä¸ä¸€å®šæ˜¯åœ¨possible_keysä¸­ã€‚

ç¤ºä¾‹ï¼š
```
-- è¦†ç›–ç´¢å¼•
mysql> EXPLAIN SELECT emp_no FROM employees;
+----+-------------+-----------+------------+-------+---------------+------------------------+---------+------+--------+----------+-------------+
| id | select_type | table     | partitions | type  | possible_keys | key                    | key_len | ref  | rows   | filtered | Extra       |
+----+-------------+-----------+------------+-------+---------------+------------------------+---------+------+--------+----------+-------------+
|  1 | SIMPLE      | employees | NULL       | index | NULL          | ind_employees_birthday | 3       | NULL | 299343 |   100.00 | Using index |
+----+-------------+-----------+------------+-------+---------------+------------------------+---------+------+--------+----------+-------------+
```

#### 2.2.8. key_len
mysqlåœ¨ç´¢å¼•é‡Œä½¿ç”¨å¯¹å­—èŠ‚æ•°ã€‚

#### 2.2.9. ref


#### 2.2.10. rows
mysqlä¼°è®¡ä¸ºäº†æ‰¾åˆ°æ‰€éœ€çš„è¡Œè€Œè¦è¯»å–å¯¹è¡Œæ•°ï¼Œä¼°ç®—ä¸ç²¾ç¡®ã€‚

#### 2.2.11. filtered
æ˜¾ç¤ºçš„æ˜¯é’ˆå¯¹è¡¨é‡Œç¬¦åˆæŸä¸ªæ¡ä»¶å¯¹è®°å½•æ•°çš„æ‚²è§‚æ¯”ä¾‹ä¼°ç®—ã€‚

#### 2.2.12. Extra
åœ¨å…¶ä»–åˆ—ä¸é€‚åˆå±•ç¤ºçš„ä¿¡æ¯ã€‚å¸¸è§ä¿¡æ¯å¦‚ä¸‹ï¼š
* Using index
æ­¤å€¼è¡¨ç¤ºmysqlå°†ä½¿ç”¨è¦†ç›–ç´¢å¼•
* Using where
æ­¤å€¼è¡¨ç¤ºmysqlå°†åœ¨å­˜å‚¨å¼•æ“æ£€ç´¢è¡Œåå†è¿›è¡Œè¿‡æ»¤(å›è¡¨)

* Using temporary
æ­¤å€¼è¡¨ç¤ºå¯¹æŸ¥è¯¢ç»“æœæ’åºæ—¶ä¼šä½¿ç”¨ä¸€ä¸ªä¸´æ—¶è¡¨ã€‚
* Using filesort
æ­¤å€¼è¡¨ç¤ºmysqlä¼šå¯¹ç»“æœä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨ç´¢å¼•æ’åºï¼Œè€Œä¸æ˜¯æŒ‰ç´¢å¼•æ¬¡åºä»è¡¨é‡Œè¯»å–è¡Œã€‚

* Range checked for each record(index map:N)
æ­¤å€¼è¡¨ç¤ºæ²¡æœ‰å¥½ç”¨çš„ç´¢å¼•ï¼Œæ–°çš„ç´¢å¼•å°†åœ¨é“¾æ¥çš„æ¯ä¸€è¡Œä¸Šé‡æ–°ä¼°ç®—ã€‚Næ˜¯æ˜¾ç¤ºåœ¨possible_keysåˆ—ä¸­ç´¢å¼•çš„ä½å›¾ï¼Œå¹¶ä¸”æ˜¯å†—ä½™çš„ã€‚



ğŸ‘‰  **REFï¼šé«˜æ€§èƒ½mysql**